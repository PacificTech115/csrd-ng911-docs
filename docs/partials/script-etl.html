<!-- PAGE HEADER -->
<header class="page-header">
  <div class="page-header-content">
    <div class="breadcrumb">
      <a href="#Documentation">Home</a>
      <span class="sep"><i class="fas fa-chevron-right"></i></span>
      <a href="#automation-scripts">ArcGIS Notebooks</a>
      <span class="sep"><i class="fas fa-chevron-right"></i></span>
      <span class="current">Salmon Arm ETL Sync</span>
    </div>
    <div class="detail-banner">
      <div class="banner-icon" style="background:var(--navy)">
        <i class="fas fa-arrows-rotate"></i>
      </div>
      <div class="banner-info">
        <h1>Salmon Arm ETL Sync</h1>
        <div class="banner-tags">
          <span class="banner-tag"><i class="fas fa-book"></i>&nbsp; Type: Notebook</span>
          <span class="banner-tag"><i class="fas fa-file-code"></i>&nbsp; File: 2.NG911-SalmonArmETL.py</span>
        </div>
      </div>
    </div>
  </div>
</header>

<div class="content-wrap">

<!-- PURPOSE -->
<section>
  <h2 class="reveal"><i class="fas fa-bullseye"></i>&nbsp; Purpose</h2>
  <p class="reveal">Syncs a hosted feature service maintained by the City of Salmon Arm into the enterprise CSRD addressing layer. The ETL performs three operations: <strong>inserts</strong> for new features, <strong>updates</strong> (both attributes and geometry) for changed features, and <strong>deletes</strong> for features removed from the source. After sync, it optionally pushes NGUID and CentralGlobalID values back to the source layer.</p>
</section>

<!-- FULL SOURCE CODE -->
<section>
  <h2 class="reveal"><i class="fas fa-file-code"></i>&nbsp; Full Source Code</h2>
  <div class="doc-meta reveal">
    <span><i class="fas fa-ruler-horizontal"></i> 734 lines</span>
    <span><i class="fas fa-file-code"></i> 2.NG911-SalmonArmETL.py</span>
  </div>
  <button class="doc-toggle reveal" type="button" data-target="etl-full-source" aria-expanded="false">
    <i class="fas fa-chevron-right"></i><span>Show full source (734 lines)</span>
  </button>
  <div id="etl-full-source" class="doc-body collapsed">
    <div class="code-block">
      <div class="code-header">
        <span class="lang-tag">Python &mdash; 2.NG911-SalmonArmETL.py</span>
        <button class="copy-btn" onclick="copyCode(this)">Copy</button>
      </div>
      <pre><span class="cmt">"""
Standalone ArcGIS Notebook script:
Sync hosted source layer -&gt; enterprise feature service layer.
Supports: Inserts, Updates (attributes + geometry), Deletes.
"""</span>

<span class="kw">from</span> arcgis.gis <span class="kw">import</span> GIS
<span class="kw">from</span> arcgis.features <span class="kw">import</span> FeatureLayer
<span class="kw">from</span> datetime <span class="kw">import</span> datetime, timezone
<span class="kw">import</span> json, os

<span class="cmt"># CONFIG</span>
SOURCE_FEATURESERVER_URL = <span class="str">"https://apps.csrd.bc.ca/.../SalmonArmOverwrite/FeatureServer"</span>
TARGET_FEATURESERVER_URL = <span class="str">"https://apps.csrd.bc.ca/.../NG911_Address_SalmonArm_Edit/FeatureServer"</span>
PRIMARY_KEY_FIELD = <span class="str">"NGUID"</span>
ENABLE_GLOBALID_FALLBACK = <span class="bi">True</span>
ENABLE_FEATUREID_FALLBACK = <span class="bi">True</span>
ENABLE_REVERSE_ID_SYNC = <span class="bi">True</span>
BATCH_SIZE = <span class="num">200</span>
DELETE_MISSING_FROM_TARGET = <span class="bi">True</span>
DRY_RUN = <span class="bi">False</span>

<span class="cmt"># ── Key Normalization &amp; Layer Resolution ──</span>
<span class="kw">def</span> <span class="fn">normalize_key</span>(val): ...
<span class="kw">def</span> <span class="fn">resolve_layer</span>(url, layer_index): ...
<span class="kw">def</span> <span class="fn">derive_transfer_fields</span>(source, target, schema_fields, key): ...

<span class="cmt"># ── Feature Fetching ──</span>
<span class="kw">def</span> <span class="fn">fetch_all_features</span>(layer, out_fields, return_geometry=<span class="bi">True</span>): ...
<span class="kw">def</span> <span class="fn">build_index</span>(features, key_field, normalizer): ...

<span class="cmt"># ── Diff &amp; Edit ──</span>
<span class="kw">def</span> <span class="fn">build_add_feature</span>(src, field_map, src_key, tgt_key): ...
<span class="kw">def</span> <span class="fn">build_update_feature</span>(src, tgt, field_map, oid_field): ...
<span class="kw">def</span> <span class="fn">run_edits</span>(target_layer, adds, updates, delete_oids, dry_run): ...

<span class="cmt"># ── Reverse ID Sync ──</span>
<span class="kw">def</span> <span class="fn">build_reverse_id_updates</span>(update_pairs, ...): ...
<span class="kw">def</span> <span class="fn">run_source_id_sync_edits</span>(source_layer, updates, dry_run): ...

<span class="cmt"># ── Main ──</span>
<span class="kw">def</span> <span class="fn">main</span>():
    gis = GIS(<span class="str">"home"</span>)
    source = resolve_layer(SOURCE_FEATURESERVER_URL, LAYER_INDEX)
    target = resolve_layer(TARGET_FEATURESERVER_URL, LAYER_INDEX)

    <span class="cmt"># Fetch, index, diff, fallback match, edit, reverse sync, notify</span>
    ...</pre>
    </div>
  </div>
</section>

<!-- MATCHING STRATEGY -->
<section>
  <h2 class="reveal"><i class="fas fa-link"></i>&nbsp; Matching Strategy</h2>
  <div class="card reveal">
    <p>Features are matched between source and target using a cascading key strategy:</p>
    <table>
      <thead><tr><th>Priority</th><th>Key</th><th>Method</th></tr></thead>
      <tbody>
        <tr><td><strong>Primary</strong></td><td><code>NGUID</code></td><td>Case-insensitive string comparison of the full NGUID URN</td></tr>
        <tr><td><strong>Fallback 1</strong></td><td><code>GlobalID</code></td><td>GUID-normalized (braces stripped, lowercased) comparison</td></tr>
        <tr><td><strong>Fallback 2</strong></td><td><code>Featureid</code></td><td>Exact string match on the Featureid field</td></tr>
      </tbody>
    </table>
    <div class="alert info"><i class="fas fa-info-circle"></i><span>The cascading strategy ensures matching works for both established records (with NGUID) and newly created features that may only have a GlobalID or Featureid.</span></div>
  </div>
</section>

<!-- CONFIGURATION -->
<section>
  <h2 class="reveal"><i class="fas fa-sliders"></i>&nbsp; Configuration</h2>
  <button class="doc-toggle reveal" type="button" data-target="tbl-etl-config" aria-expanded="false">
    <i class="fas fa-chevron-right"></i><span>Show table (6 rows)</span>
  </button>
  <div id="tbl-etl-config" class="doc-body collapsed">
    <div class="card">
      <table>
        <thead><tr><th>Parameter</th><th>Value</th><th>Description</th></tr></thead>
        <tbody>
          <tr><td><code>SOURCE_URL</code></td><td>Salmon Arm hosted feature service URL</td><td>ArcGIS Online / Portal feature service endpoint for the source data</td></tr>
          <tr><td><code>TARGET_URL</code></td><td>Enterprise feature service URL</td><td>CSRD enterprise feature service endpoint for the target layer</td></tr>
          <tr><td><code>BATCH_SIZE</code></td><td><code>200</code></td><td>Number of features per edit batch (insert/update/delete)</td></tr>
          <tr><td><code>DELETE_MISSING</code></td><td><code>True</code></td><td>Delete features from target that no longer exist in source</td></tr>
          <tr><td><code>REVERSE_ID_SYNC</code></td><td><code>True</code></td><td>Push NGUID and CentralGlobalID back to the source layer after matching</td></tr>
          <tr><td><code>DRY_RUN</code></td><td><code>False</code></td><td>When True, computes diffs but does not apply any edits</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<!-- KEY FUNCTIONS -->
<section>
  <h2 class="reveal"><i class="fas fa-code"></i>&nbsp; Key Functions</h2>
  <div class="card reveal">
    <table>
      <thead><tr><th>Function</th><th>Purpose</th></tr></thead>
      <tbody>
        <tr><td><code>fetch_all_features(layer)</code></td><td>Paginated query (2000 features per page) to retrieve all features from a layer</td></tr>
        <tr><td><code>build_index(features, key_field)</code></td><td>Builds a dictionary index keyed by the specified field for O(1) lookups during matching</td></tr>
        <tr><td><code>derive_transfer_fields(source_schema, target_schema)</code></td><td>Computes the intersection of fields approved for transfer based on schema compatibility</td></tr>
        <tr><td><code>run_edits(layer, adds, updates, deletes)</code></td><td>Executes batched edit operations (200 per batch) with error collection per batch</td></tr>
        <tr><td><code>build_reverse_id_updates(matched_pairs)</code></td><td>Constructs update payloads to sync NGUID and CentralGlobalID back to the source layer</td></tr>
      </tbody>
    </table>
  </div>
</section>

<!-- REVERSE ID SYNC -->
<section>
  <h2 class="reveal"><i class="fas fa-rotate"></i>&nbsp; Reverse ID Sync</h2>
  <div class="card reveal">
    <p>After matching and syncing features from source to target, the ETL optionally performs a <strong>reverse ID sync</strong>. This writes the enterprise-generated <code>NGUID</code> and <code>CentralGlobalID</code> values back to the source Salmon Arm hosted layer, ensuring both systems share consistent identifiers for future sync cycles.</p>
    <div class="grid-2" style="margin-top:12px">
      <div class="alert success"><i class="fas fa-check-circle"></i><span><strong>Enabled:</strong> <code>REVERSE_ID_SYNC = True</code> — the default. After each sync run, matched features in the source layer receive the enterprise NGUID and CentralGlobalID.</span></div>
      <div class="alert warning"><i class="fas fa-exclamation-triangle"></i><span><strong>Disabled:</strong> Set <code>REVERSE_ID_SYNC = False</code> only when testing or if the source layer is read-only. This prevents write-back operations.</span></div>
    </div>
  </div>
</section>

<!-- SECTION BREAKDOWN -->
<section>
  <h2 class="reveal"><i class="fas fa-layer-group"></i>&nbsp; Section-by-Section Breakdown</h2>

  <div class="card reveal doc-section">
    <h4>1. Configuration Block</h4>
    <div class="doc-meta"><span>Lines 19 &ndash; 47</span><span>Constants</span></div>
    <div class="breakdown-detail">
      <strong>Key Variables</strong>
      <ul>
        <li><code>SOURCE_FEATURESERVER_URL</code> &mdash; Hosted feature service (Salmon Arm publishes here).</li>
        <li><code>TARGET_FEATURESERVER_URL</code> &mdash; Enterprise feature service (central NG911 SalmonArm edit layer).</li>
        <li><code>PRIMARY_KEY_FIELD</code> &mdash; <code>NGUID</code>. Used to match source records to target records.</li>
        <li><code>ENABLE_GLOBALID_FALLBACK</code> / <code>ENABLE_FEATUREID_FALLBACK</code> &mdash; When primary key doesn&rsquo;t match, try matching by GlobalID or Featureid.</li>
        <li><code>ENABLE_REVERSE_ID_SYNC</code> &mdash; After syncing, writes target GlobalID and NGUID back to source layer.</li>
        <li><code>BATCH_SIZE</code> &mdash; Number of features per edit batch (200).</li>
        <li><code>DELETE_MISSING_FROM_TARGET</code> &mdash; If True, removes target records not found in source.</li>
        <li><code>DRY_RUN</code> &mdash; If True, calculates all operations but does not apply edits.</li>
      </ul>
      <strong>To modify</strong>
      <ul>
        <li>Add a new sync source: duplicate this script and update the source/target URLs.</li>
        <li>Disable deletes: set <code>DELETE_MISSING_FROM_TARGET = False</code>.</li>
        <li>Test without writing: set <code>DRY_RUN = True</code>.</li>
      </ul>
    </div>
  </div>

  <div class="card reveal doc-section">
    <h4>2. Layer &amp; Schema Resolution</h4>
    <div class="doc-meta"><span>Lines 50 &ndash; 173</span><span>10 functions</span></div>
    <div class="breakdown-detail">
      <strong>Key Functions</strong>
      <ul>
        <li><code>resolve_layer(url, index)</code> &mdash; Appends layer index to FeatureServer URL if needed.</li>
        <li><code>load_schema_field_names()</code> &mdash; Reads <code>SSAP_Schema.json</code> to get the approved field name list.</li>
        <li><code>derive_transfer_fields()</code> &mdash; Intersects source fields, target fields, and schema fields to produce the transfer mapping. Excludes system fields.</li>
        <li><code>resolve_actual_field_name()</code> &mdash; Case-insensitive field name resolution against the live layer.</li>
      </ul>
      <strong>Logic</strong>
      <p>Only fields that exist in <em>all three</em> (source layer, target layer, schema JSON) are transferred.</p>
    </div>
  </div>

  <div class="card reveal doc-section">
    <h4>3. Feature Fetching &amp; Indexing</h4>
    <div class="doc-meta"><span>Lines 176 &ndash; 286</span><span>4 functions</span></div>
    <div class="breakdown-detail">
      <strong>Key Functions</strong>
      <ul>
        <li><code>fetch_all_features()</code> &mdash; Paginates through the entire layer (2000 records/page).</li>
        <li><code>build_index(features, key_field)</code> &mdash; Creates a dictionary keyed by normalized primary key. Reports skipped and duplicate counts.</li>
        <li><code>geometry_changed(src, tgt)</code> &mdash; JSON-serializes both geometries for deep comparison.</li>
      </ul>
    </div>
  </div>

  <div class="card reveal doc-section">
    <h4>4. Diff &amp; Edit Payloads</h4>
    <div class="doc-meta"><span>Lines 288 &ndash; 350</span><span>4 functions</span></div>
    <div class="breakdown-detail">
      <strong>Functions</strong>
      <ul>
        <li><code>build_add_feature()</code> &mdash; Constructs an insert payload from source feature.</li>
        <li><code>build_update_feature()</code> &mdash; Compares each mapped field; returns <code>None</code> if nothing changed.</li>
        <li><code>chunks(items, size)</code> &mdash; Splits edit lists into batches of <code>BATCH_SIZE</code>.</li>
        <li><code>run_edits()</code> &mdash; Applies adds, updates, and deletes in batches.</li>
      </ul>
    </div>
  </div>

  <div class="card reveal doc-section">
    <h4>5. Fallback Key Matching</h4>
    <div class="doc-meta"><span>Lines 550 &ndash; 603</span><span>Core matching logic</span></div>
    <div class="breakdown-detail">
      <strong>Logic</strong>
      <ul>
        <li>Primary match by <code>NGUID</code>: source &cap; target = updates; source-only = inserts; target-only = deletes.</li>
        <li>GlobalID fallback: unmatched records re-indexed by GlobalID.</li>
        <li>Featureid fallback: same process with <code>Featureid</code> for still-unmatched records.</li>
        <li>Final insert/delete lists exclude records resolved by fallback.</li>
      </ul>
      <strong>To modify</strong>
      <ul>
        <li>Add a new fallback field: append a definition to the <code>fallback_definitions</code> list.</li>
      </ul>
    </div>
  </div>

  <div class="card reveal doc-section">
    <h4>6. Reverse ID Sync</h4>
    <div class="doc-meta"><span>Lines 353 &ndash; 408</span><span>2 functions</span></div>
    <div class="breakdown-detail">
      <strong>Purpose</strong>
      <p>After syncing source &rarr; target, writes the target&rsquo;s NGUID and GlobalID <em>back</em> to the source layer into <code>CentralGlobalID</code>.</p>
      <strong>Functions</strong>
      <ul>
        <li><code>build_reverse_id_updates()</code> &mdash; Patches source OID with target NGUID/GlobalID.</li>
        <li><code>run_source_id_sync_edits()</code> &mdash; Applies the reverse updates in batches.</li>
      </ul>
    </div>
  </div>

  <div class="card reveal doc-section">
    <h4>7. Main &amp; Notification</h4>
    <div class="doc-meta"><span>Lines 486 &ndash; 734</span><span>Entry point</span></div>
    <div class="breakdown-detail">
      <strong>Flow</strong>
      <ul>
        <li>Signs in &rarr; resolves layers &rarr; resolves fields &rarr; configures fallbacks.</li>
        <li>Fetches all source and target features &rarr; builds indexes &rarr; computes diff.</li>
        <li>Runs fallback matching &rarr; builds add/update/delete payloads &rarr; applies edits.</li>
        <li>Optionally runs reverse ID sync &rarr; saves result JSON &rarr; sends Power Automate notification.</li>
      </ul>
      <strong>Output</strong>
      <p>JSON run summary with: record counts, key match stats, fallback stats, planned vs. applied operations, failure samples, reverse sync status.</p>
    </div>
  </div>
</section>

</div><!-- /content-wrap -->

<!-- FOOTER -->