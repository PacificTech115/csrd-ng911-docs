window.CSRD_SEARCH_INDEX = [{"title":"CSRD NG911 â€” Documentation Hub","path":"Documentation.html","content":"Schema Guide Detailed database structure, feature classes, and fields. Attribute Rules Validation rules, constraint formulas, and attribute calculations. Maintenance Guide Instructions and best practices for system operations and troubleshooting. Automation Scripts Documentation for Python scripts and FME workflows. Domains \u0026amp; Lookups Coded value domains, lookup tables, and data validation. Quick Reference Pipeline stages, version naming, and connection info.","pageId":"Documentation.html"},{"title":"System Architecture","path":"docs/architecture.html","content":"\u0026nbsp; Overview The central database uses ArcGIS Enterprise traditional versioning to manage concurrent edits from multiple municipal agencies. Data flows upward from editor versions through a QA gate before reaching the production DEFAULT layer. Versioning Hierarchy \u0026nbsp; sde.DEFAULT Production \u0026middot; Authoritative Layer Reconcile / Post \u0026nbsp; SDE.QA QA Validation Gate Reconcile / Post SDE.CSRD Editor SDE.Salmon Arm Editor SDE.Sicamous Editor SDE.Golden Editor SDE.Revelstoke Editor Technology Stack Database Microsoft SQL Server + ArcSDE for versioned geodatabase storage GIS Platform ArcGIS Enterprise (Portal, Server) for feature services and GP services Editing ArcGIS Pro \u0026amp; Experience Builder for desktop and web-based entry Automation ArcGIS Notebook Server (Python) for nightly orchestration and ETL Notifications Microsoft Power Automate for email reports on pipeline completion Attribute Rules Arcade expressions for auto-calculation of fields on every save Feature Class The primary dataset is SDE.NG911\\SDE.NG911_SiteAddress (SSAP \u0026mdash; Site/Structure Address Point), containing all address points for the CSRD region with NENA-standard fields.","pageId":"architecture.html"},{"title":"Attribute Rules","path":"docs/attribute-rules.html","content":"Attribute rules execute in order. Full_Addr depends on component fields and QAStatus watches Full_Addr, so ordering matters. Rules run server-side within the geodatabase on every Insert and Update. Calculation Rules 1. Full Address Full_Addr Concatenates 16 address component fields into a formatted string 2. NGUID NGUID Generates URN-format National Geographic Unique Identifier 3. Longitude Long Extracts X coordinate, converts Web Mercator to degrees 4. Latitude Lat Extracts Y coordinate, converts Web Mercator to degrees 5. AddCode AddCode Maps municipality name to numeric code (39 communities) 6. DateUpdate DateUpdate Sets to last_edited_date on every save 7. QAStatus QAStatus Business logic: Pending on insert, reset on field changes, preserve explicit edits 8. Default Agency INACTIVE Auto-populates Agency, A3, DiscrpAgID on insert based on editing user Constraint Rules A. Mandatory Fields Constraint Blocks save if any of 8 mandatory fields (Full_Addr, Agency, DiscrpAgID, NGUID, Country, A1, A2, A3) are blank","pageId":"attribute-rules.html"},{"title":"ArcGIS Notebooks","path":"docs/automation-scripts.html","content":"Nightly Pipeline Flow Stage 1 MUNI \u0026rarr; QA Stage 2 Run QA Stage 3 QA \u0026rarr; DEFAULT Stage 4 Export FGDB Stage 5 DEFAULT \u0026rarr; MUNI Nightly Orchestrator Notebook Master pipeline: 5-stage nightly reconcile, QA, export, and sync Reconcile/Post GP QA Validation GP Export GP Power Automate Salmon Arm ETL Notebook Hosted-to-enterprise sync with insert/update/delete and reverse ID sync Power Automate","pageId":"automation-scripts.html"},{"title":"Field Domains","path":"docs/domains.html","content":"\u0026nbsp; Agency Domain Applied to the Agency field. Represents the owning agency. Show table (10 rows) Code Description CSRD CSRD Golden Golden Revelstoke Revelstoke Salmon Arm Salmon Arm Sicamous Sicamous Adams Lake Adams Lake Neskonlith Neskonlith RDNO RDNO Skw\u0027lax te SecwepemcÃºl\u0027ecw Skw\u0027lax te SecwepemcÃºl\u0027ecw Splatsin Splatsin \u0026nbsp; DiscrpAgID Domain Applied to the DiscrpAgID field. Domain-based identifier embedded in NGUID. Show table (10 rows) Code Description csrd.bc.ca csrd.bc.ca golden.ca golden.ca revelstoke.ca revelstoke.ca salmonarm.ca salmonarm.ca sicamous.ca sicamous.ca adamslakeband.org adamslakeband.org neskonlith.net neskonlith.net rdno.ca rdno.ca lslb.ca lslb.ca splatsin.ca splatsin.ca \u0026nbsp; Locality (A3) Domain Applied to the A3 (Locality) field. Must match the AddCode lookup table for code assignment. Show table (44 rows) Code Description Anglemont Anglemont Anstey Arm Anstey Arm Beaton Beaton Blaeberry Blaeberry Blind Bay Blind Bay Canyon Hot Springs Canyon Hot Springs Castledale Castledale Celista Celista Craigellachie Craigellachie Deep Creek Deep Creek Donald Donald Eagle Bay Eagle Bay East Salmon Arm East Salmon Arm Enderby Enderby Falkland Falkland Field Field Galena Bay Galena Bay Golden Golden Grandview Bench Grandview Bench Heywoods Heywoods Leanchoil Leanchoil Lee Creek Lee Creek Magna Bay Magna Bay Malakwa Malakwa Mica Creek Mica Creek North Mara North Mara Notch Hill Notch Hill Okanagan IR North Okanagan IR North Parson Parson Revelstoke Revelstoke Rogers Pass Rogers Pass Salmon Arm Salmon Arm Salmon River IR Salmon River IR Scotch Creek Scotch Creek Seymour Arm Seymour Arm Sicamous Sicamous Solsqua Solsqua Sorrento Sorrento South Kinbasket Lake South Kinbasket Lake St. Ives St. Ives Tappen Tappen Three Valley Three Valley Trout Lake Trout Lake White Lake White Lake \u0026nbsp; AddCode Lookup Table Maps A3 (Locality) to numeric AddCode. Used by Attribute Rule #5. Keys are uppercased with periods stripped. Show table (41 rows) A3 Locality Key AddCode ANSTEY ARM 1066 BEATON 60 BLAEBERRY 1054 BLIND BAY 581 CANYON HOT SPRINGS 1053 CASTLEDALE 18 CELISTA 594 CRAIGELLACHIE 182 DEEP CREEK 577 DONALD 180 EAGLE BAY 593 FALKLAND 586 FIELD 795 GALENA BAY 61 GOLDEN 179 HEYWOODS 587 LEANCHOLI 1056 LEE CREEK 597 MAGNA BAY 880 MALAKWA 185 MICA CREEK 183 NORTH MARA 584 NOTCH HILL 592 OKANAGAN IR NORTH 1119 PARSON 19 REVELSTOKE 181 ROGERS PASS 178 SALMON ARM 574 SALMON RIVER IR 1118 SCOTCH CREEK 598 SEYMOUR ARM 1065 SICAMOUS 583 SOLSQUA 186 SORRENTO 580 SOUTH KINBASKET LAKE 872 SPALLUMCHEEN 1075 ST IVES 595 TAPPEN 576 THREE VALLEY 555 TROUT LAKE 59 WHITE LAKE 582","pageId":"domains.html"},{"title":"ArcGIS GP Tools","path":"docs/gp-tools.html","content":"These GP services run server-side on ArcGIS Server and are called by the Nightly Orchestrator notebook. They operate directly on the enterprise geodatabase. QA Validation Tool GP Service Schema validation, NGUID checks, mandatory nulls, duplicate detection Reconcile/Post Tool GP Service Traditional versioning reconcile/post with 3 stage modes Export Tool GP Service Exports DEFAULT to FGDB ZIP, copies to network share How GP Tools Fit the Pipeline The Nightly Orchestrator notebook (an ArcGIS Notebook Server script) calls these GP tools as server-side operations via their REST endpoints. Each tool runs within the ArcGIS Server context with direct SDE access to the enterprise geodatabase. Orchestrator Notebook calls REST endpoints GP Tools QA Â· Reconcile Â· Export operates on Enterprise GDB","pageId":"gp-tools.html"},{"title":"CSRD NG911 â€” Maintenance Guide","path":"docs/maintenance.html","content":"\u0026nbsp; Nightly Pipeline Monitoring Verify the Pipeline Ran Check your inbox for the nightly pipeline status report email. Look for nightly_orchestrator_{ts}.json in /arcgis/home/run_summaries/ Browse the ArcGIS Notebook scheduled task history in Portal for execution logs. Interpret the Email Report Green PASSED \u0026mdash; All 5 pipeline stages completed successfully Red FAILED \u0026mdash; One or more stages failed; check the stage breakdown to identify which Amber warnings \u0026mdash; Pipeline completed but QA found non-blocking issues (duplicates, warnings) \u0026nbsp; Common Troubleshooting Reconcile Conflicts Symptom: \\\"conflicts detected, aborting the reconcile\\\" in pipeline logs Cause: Two versions edited the same feature/row and the conflict policy is set to abort Fix: Open the affected version in ArcGIS Pro \u0026rarr; Reconcile manually \u0026rarr; use Conflict Manager to review each conflict \u0026rarr; Resolve \u0026rarr; Save \u0026rarr; Post. Production uses NO_ABORT which auto-resolves. Only switch to ABORT_CONFLICTS if you need manual conflict review. Version Lock Issues Symptom: Lock acquisition errors preventing reconcile from starting Cause: Active editing sessions or stale connections holding version locks Fix: Confirm the scheduled run time is outside business hours. Disconnect stale sessions in ArcGIS Server Manager. As a last resort, temporarily set NO_LOCK_ACQUIRED (use with caution). GP Tool Timeout Symptom: \\\"timed out after 1800 sec\\\" in the orchestrator logs Cause: Large dataset, missing spatial index, or resource contention on the server Fix: Check GP service logs for the slow operation, increase timeout in _poll_job_result() , or rebuild the spatial index on the feature class. Notification Failures Symptom: No email received after a pipeline run completes Cause: Power Automate flow disabled, URL expired, or network connectivity issue Fix: Verify POWER_AUTOMATE_FLOW_URL is valid and accessible. Check the Flow is enabled in the Power Automate portal. Review the run summary JSON for notification dispatch status. \u0026nbsp; Adding a New Municipality Create the version: In ArcGIS Pro or Server Manager, create a new child version of SDE.QA named SDE.{MunicipalityName} Update the orchestrator config: Add the new version name to the EDITOR_VERSIONS semicolon-delimited string: Python Copy EDITOR_VERSIONS = \\\"SDE.CSRD;SDE.Revelstoke;SDE.Golden;SDE.Salmon Arm;SDE.Sicamous;SDE.NewMuni\\\" Update AddCode rule: Add the new community name-to-code mapping in Attribute Rule 5 (AddCode lookup dictionary) Republish: Save and republish the Notebook to ArcGIS Notebook Server Test: Trigger a manual pipeline run and verify the new version appears in reconcile logs and the email report \u0026nbsp; Updating Attribute Rules Open ArcGIS Pro and connect to the enterprise geodatabase Right-click the feature class \u0026rarr; Properties \u0026rarr; Attribute Rules tab Select the rule to edit and modify the Arcade expression Click Validate to check for syntax errors Save â€” changes take effect immediately for all new edits across all versions Copy the updated Arcade source to Database Automation/0.Attribute Rules/ for version control Attribute rule changes affect all versions simultaneously . Always test modifications in a development environment before applying to production. \u0026nbsp; Export Verification Navigate to \\\\GIS\\Scripts\\Geoshare\\NG911 Exports on the network share Verify a ZIP file with today\u0027s date timestamp exists (format: {prefix}_{YYYYMMDD_HHmmss}.zip ) Extract and open the FGDB in ArcGIS Pro \u0026rarr; spot-check feature counts and a few records Compare the record count with the QA report\u0027s total row count to ensure no data was dropped \u0026nbsp; Salmon Arm Sync Maintenance Task Configuration Change Details Change source/target URLs Edit SOURCE_URL / TARGET_URL Update the feature service endpoints if the services are republished or moved Update schema mapping Modify SSAP_Schema.json Add or rename fields in the schema file; the ETL auto-detects transferable fields Test without applying edits DRY_RUN = True Computes the full diff (inserts, updates, deletes) but writes nothing â€” check logs for what would happen Disable delete operations DELETE_MISSING = False Prevents removal of target features that are missing from source â€” useful during partial source updates Disable reverse ID sync REVERSE_ID_SYNC = False Stops writing NGUID/CentralGlobalID back to the source layer â€” use when source is read-only or testing","pageId":"maintenance.html"},{"title":"Power Automate Notifications","path":"docs/power-automate.html","content":"Both automation workflows send JSON payloads to Power Automate flows, which format and deliver HTML email reports to stakeholders. Nightly Pipeline Report Template PowerautomateEmail-Reconcile-QA-Reconcile-Export.html Status badge (PASSED / FAILED) Run metadata \u0026amp; timestamps QA counters, detail table, blocking samples Issues-by-agency breakdown Pipeline stages with per-stage status Output file links Salmon Arm Sync Report Template PowerautomateEmail-SalmonArmsync.html Status badge (SUCCESS / FAILED) Source/target layer info Record matching details Operations: inserts, updates, deletes Failure count \u0026amp; reverse ID sync status Payload Dispatch Python Copy def send_power_automate_notification (payload: dict ): flow_url = POWER_AUTOMATE_FLOW_URL.strip() if not flow_url: return { \\\"skipped\\\" : True } import requests resp = requests.post(flow_url, json=payload, timeout= 20 ) return { \\\"status_code\\\" : resp.status_code} How It Works Each automation script builds a JSON payload with run results (status, counters, errors, timestamps) and POSTs it to a Power Automate HTTP trigger URL. The flow formats the JSON into a styled HTML email using the templates above and delivers it to the configured recipients.","pageId":"power-automate.html"},{"title":"CSRD NG911 â€” Quick Reference","path":"docs/quick-reference.html","content":"\u0026nbsp; Pipeline Stages # GP Service Task Post? 1 ReconcilePost MUNI_TO_QA Yes 2 QA SSAP qa N/A 3 ReconcilePost QA_TO_DEFAULT Yes 4 ExportSSAP export_ssap N/A 5 ReconcilePost DEFAULT_TO_MUNI No \u0026nbsp; Version Naming Show table (7 rows) Version Purpose sde.DEFAULT Production authoritative SDE.QA QA staging gate SDE.CSRD CSRD regional editor SDE.Salmon Arm City of Salmon Arm SDE.Sicamous District of Sicamous SDE.Golden Town of Golden SDE.Revelstoke City of Revelstoke \u0026nbsp; File Paths \u0026amp; GP URLs File Paths Resource Path SDE Connection \\\\GIS\\Scripts\\NG911\\...\\sde@regional.sde Schema JSON \\\\GIS\\Scripts\\NG911\\...\\SSAP_Schema.json Export Directory \\\\GIS\\Scripts\\Geoshare\\NG911 Exports Run Summaries /arcgis/home/run_summaries/ GP Service URLs GP Service URL Reconcile apps.csrd.bc.ca/.../ReconcilePost.../GPServer QA apps.csrd.bc.ca/.../Regional/QA/GPServer Export apps.csrd.bc.ca/.../ExportSSAP/GPServer \u0026nbsp; Attribute Rules Summary Show table (9 rows) # Rule Target Field Type Depends On 1 Full Address Full_Addr Calculation 16 component fields (Unit, Add_Number, St_Name, A3, A1, etc.) 2 NGUID NGUID Calculation GlobalID, DiscrpAgID 3 Longitude Long Calculation Geometry (X coordinate) 4 Latitude Lat Calculation Geometry (Y coordinate) 5 AddCode AddCode Calculation A3 (municipality name) 6 DateUpdate DateUpdate Calculation last_edited_date 7 QAStatus QAStatus Calculation 7 watched fields (DiscrpAgID, NGUID, Country, A1, A2, A3, Full_Addr) 8 Default Agency Agency, A3, DiscrpAgID Calculation GetUser() username (INACTIVE) A Mandatory Fields (validation) Constraint Full_Addr, Agency, DiscrpAgID, NGUID, Country, A1, A2, A3 \u0026nbsp; Mandatory QA Fields These fields are checked for null or empty values during every QA validation run. Any feature missing one of these fields will receive a blocking error status. \u0026nbsp; DiscrpAgID \u0026nbsp; DateUpdate \u0026nbsp; NGUID \u0026nbsp; Country \u0026nbsp; A3 \u0026nbsp; A2 \u0026nbsp; A1","pageId":"quick-reference.html"},{"title":"5. AddCode â€” CSRD NG911 Attribute Rule","path":"docs/rule-addcode.html","content":"Description Maps the municipality name (from field A3 ) to its corresponding numeric address code using a hardcoded lookup dictionary of 39 CSRD communities. The municipality name is normalized (uppercased, periods stripped) before lookup. Returns Null if the municipality name is not found in the dictionary. Metadata Property Value Target Field AddCode Triggers Insert, Update Input Fields A3 (municipality name) Lookup Entries 39 communities Returns Numeric code or Null if not found Full Source Code Arcade Copy var key = Upper ( Replace ( Trim ( $feature .A3), \\\".\\\" , \\\"\\\" )); if ( IsEmpty (key)) { return null ; } var m = { \\\"ANSTEY ARM\\\" : 1066 , \\\"BEATON\\\" : 60 , \\\"BLAEBERRY\\\" : 1054 , \\\"BLIND BAY\\\" : 581 , \\\"CANYON HOT SPRINGS\\\" : 1053 , \\\"CASTLEDALE\\\" : 18 , \\\"CELISTA\\\" : 594 , \\\"CRAIGELLACHIE\\\" : 182 , \\\"DEEP CREEK\\\" : 577 , \\\"DONALD\\\" : 180 , \\\"EAGLE BAY\\\" : 593 , \\\"FALKLAND\\\" : 586 , \\\"FIELD\\\" : 795 , \\\"GALENA BAY\\\" : 61 , \\\"GOLDEN\\\" : 179 , \\\"HEYWOODS\\\" : 587 , \\\"LEANCHOLI\\\" : 1056 , \\\"LEE CREEK\\\" : 597 , \\\"MAGNA BAY\\\" : 880 , \\\"MALAKWA\\\" : 185 , \\\"MICA CREEK\\\" : 183 , \\\"NORTH MARA\\\" : 584 , \\\"NOTCH HILL\\\" : 592 , \\\"OKANAGAN IR NORTH\\\" : 1119 , \\\"PARSON\\\" : 19 , \\\"REVELSTOKE\\\" : 181 , \\\"ROGERS PASS\\\" : 178 , \\\"SALMON ARM\\\" : 574 , \\\"SALMON RIVER IR\\\" : 1118 , \\\"SCOTCH CREEK\\\" : 598 , \\\"SEYMOUR ARM\\\" : 1065 , \\\"SICAMOUS\\\" : 583 , \\\"SOLSQUA\\\" : 186 , \\\"SORRENTO\\\" : 580 , \\\"SOUTH KINBASKET LAKE\\\" : 872 , \\\"SPALLUMCHEEN\\\" : 1075 , \\\"ST IVES\\\" : 595 , \\\"TAPPEN\\\" : 576 , \\\"THREE VALLEY\\\" : 555 , \\\"TROUT LAKE\\\" : 59 , \\\"WHITE LAKE\\\" : 582 }; return IIF ( HasKey (m, key), Number (m[key]), null ); Section Breakdown 1. Key Normalization Lines 1â€“4 Input: A3 Output: string or early exit Prepares the municipality name for dictionary lookup. Trims whitespace, strips periods via Replace(key, \\\".\\\", \\\"\\\") , uppercases with Upper() . Returns null if IsEmpty(key) . Logic key = Upper(Replace(Trim($feature.A3), \\\".\\\", \\\"\\\")) If IsEmpty(key) â†’ return null To replicate Replace A3 with your municipality field. Add more Replace() calls for hyphens, apostrophes, etc. if needed. To modify Case-sensitive: remove Upper() and ensure dictionary keys match. Handle \\\"St.\\\" vs \\\"Saint\\\": add Replace(key, \\\"ST \\\", \\\"SAINT \\\") before lookup. 2. Community Lookup Dictionary Lines 6â€“48 39 CSRD communities Hardcoded dictionary mapping community names (uppercase, no periods) to provincial address codes. Keys must match the normalized output of section 1. Codes come from the provincial addressing authority. Structure var m = { \\\"ANSTEY ARM\\\": 1066, \\\"BEATON\\\": 60, ... }; Keys: uppercase, no periods. Values: integer codes. To replicate Replace with your region\u0027s community list. Keep keys in sync with key normalization (section 1). To modify Add community: add \\\"NEW COMMUNITY\\\": 1234 in alphabetical order. Get code from provincial authority. Rename community: update key; ensure A3 values in data match. Remove community: delete the key-value pair; existing features will get null. 3. Lookup and Return Line 50 Output: number or null Checks if the normalized key exists in the dictionary. Returns the numeric code if found, null otherwise. Logic return IIF(HasKey(m, key), Number(m[key]), null); Number() ensures integer return type. To replicate Requires HasKey() and IIF . Use null (lowercase) for Arcade. To modify Return string code: use Text(m[key]) instead of Number(m[key]) . Default fallback: IIF(HasKey(m, key), m[key], 0) to return 0 for unknown.","pageId":"rule-addcode.html"},{"title":"6. DateUpdate â€” CSRD NG911 Attribute Rule","path":"docs/rule-dateupdate.html","content":"Description The simplest attribute rule in the system. It sets the DateUpdate field to the feature\u0027s last edited timestamp on every save. This provides a reliable, auto-populated edit date that cannot be accidentally left blank or stale. The value comes from ArcGIS\u0027s built-in last_edited_date tracking field. Metadata Property Value Target Field DateUpdate Triggers Insert, Update Input $feature.last_edited_date (system field) Returns Timestamp of the last edit Full Source Code Arcade Copy $feature .last_edited_date Section Breakdown 1. Timestamp Assignment Line 1 Input: last_edited_date (system) Output: Date Returns the system-tracked last_edited_date value. ArcGIS Enterprise maintains this automatically on every Insert and Update. No conditional logicâ€”single expression. Logic return $feature.last_edited_date; To replicate Target field: DateUpdate (or equivalent). Set rule triggers: Insert, Update. To modify Date-only (no time): DateOnly($feature.last_edited_date) Formatted string: Text($feature.last_edited_date, \\\"yyyy-MM-dd\\\") If ArcGIS renames the field in a future version, update the reference. Dependencies last_edited_date is a system-managed field; do not edit manually.","pageId":"rule-dateupdate.html"},{"title":"8. Default Agency â€” CSRD NG911 Attribute Rule","path":"docs/rule-defaultagency.html","content":"Description Automatically populates the Agency , A3 (municipality), and DiscrpAgID fields when a new feature is inserted, based on the username of the editing user. Maps known municipal editing accounts ( golden_editing , salmon_arm_editing , revelstoke_editing , sicamous_editing ) to their respective agency defaults. All other users default to CSRD. Only fills blank fields â€” does not overwrite manually entered values. Currently inactive. Inactive Rule: This rule is currently INACTIVE. It was disabled to allow manual agency assignment. If re-enabled, it will auto-populate Agency, A3, and DiscrpAgID fields on insert based on the editing user. Metadata Property Value Target Fields Agency , A3 , DiscrpAgID Triggers Insert only Status INACTIVE Input $editcontext.editType , GetUser() username User Mappings golden_editing , salmon_arm_editing , revelstoke_editing , sicamous_editing â†’ respective agencies; all others â†’ CSRD Returns Attribute update object or nothing Full Source Code Arcade Copy // Only run on INSERT if ( $editcontext .editType != \\\"INSERT\\\" ) { return ; } // Get current user var u = GetUser ( $featureSet ); if (u == null || ! HasKey (u, \\\"username\\\" )) { return ; } var uname = Lower ( Text (u[ \\\"username\\\" ])); // Normalize DOMAIN\\user if ( Find ( \\\"\\\\\\\" , uname) \u0026gt; -1 ) { var p = Split (uname, \\\"\\\\\\\" ); uname = p[ Count (p) - 1 ]; } // Normalize user@domain.com if ( Find ( \\\"@\\\" , uname) \u0026gt; -1 ) { var p2 = Split (uname, \\\"@\\\" ); uname = p2[ 0 ]; } // User -\u0026gt; defaults var defaults = { \\\"golden_editing\\\" : { \\\"Agency\\\" : \\\"Golden\\\" , \\\"A3\\\" : \\\"Golden\\\" , \\\"DiscrpAgID\\\" : \\\"golden.ca\\\" }, \\\"salmon_arm_editing\\\" : { \\\"Agency\\\" : \\\"Salmon Arm\\\" , \\\"A3\\\" : \\\"Salmon Arm\\\" , \\\"DiscrpAgID\\\" : \\\"salmonarm.ca\\\" }, \\\"revelstoke_editing\\\" : { \\\"Agency\\\" : \\\"Revelstoke\\\" , \\\"A3\\\" : \\\"Revelstoke\\\" , \\\"DiscrpAgID\\\" : \\\"revelstoke.ca\\\" }, \\\"sicamous_editing\\\" : { \\\"Agency\\\" : \\\"Sicamous\\\" , \\\"A3\\\" : \\\"Sicamous\\\" , \\\"DiscrpAgID\\\" : \\\"sicamous.ca\\\" } }; // Fallback for everyone else var row = { \\\"Agency\\\" : \\\"CSRD\\\" , \\\"A3\\\" : \\\"CSRD\\\" , \\\"DiscrpAgID\\\" : \\\"csrd.bc.ca\\\" }; if ( HasKey (defaults, uname)) { row = defaults[uname]; } // Only fill blanks (don\u0027t overwrite manual values) var updates = {}; var didUpdate = false ; if ( IsEmpty ( $feature .Agency)) { updates[ \\\"Agency\\\" ] = row[ \\\"Agency\\\" ]; didUpdate = true ; } if ( IsEmpty ( $feature .A3)) { updates[ \\\"A3\\\" ] = row[ \\\"A3\\\" ]; didUpdate = true ; } if ( IsEmpty ( $feature .DiscrpAgID)) { updates[ \\\"DiscrpAgID\\\" ] = row[ \\\"DiscrpAgID\\\" ]; didUpdate = true ; } if (!didUpdate) return ; return { \\\"result\\\" : { \\\"attributes\\\" : updates } }; Section Breakdown 1. Insert Guard Lines 1â€“4 Input: $editcontext.editType Runs only on INSERT. If editType != \\\"INSERT\\\" , returns immediately (no update). Prevents overwriting agency fields on every edit. Logic if ($editcontext.editType != \\\"INSERT\\\") return; To replicate Required for insert-only auto-population. Do not remove. 2. Username Extraction Lines 6â€“24 Input: GetUser($featureSet) Output: uname (lowercase) Gets current user via GetUser($featureSet) . Normalizes: (1) strip DOMAIN\\ prefix via Split(uname, \\\"\\\\\\\") , take last segment; (2) strip @domain.com via Split(uname, \\\"@\\\") , take first segment. Lowercases for dictionary lookup. Logic If u == null || !HasKey(u, \\\"username\\\") â†’ return uname = Lower(Text(u[\\\"username\\\"])) If Find(\\\"\\\\\\\", uname) \u003e -1 â†’ uname = Split(uname, \\\"\\\\\\\")[Count-1] If Find(\\\"@\\\", uname) \u003e -1 â†’ uname = Split(uname, \\\"@\\\")[0] To modify New SSO format: add another Split/Find block for the new pattern. 3. Agency Lookup Dictionary Lines 26â€“32 4 municipal accounts Maps usernames to default values. Keys: golden_editing , salmon_arm_editing , revelstoke_editing , sicamous_editing . Each value: { Agency, A3, DiscrpAgID } . Structure defaults[\\\"golden_editing\\\"] = { \\\"Agency\\\": \\\"Golden\\\", \\\"A3\\\": \\\"Golden\\\", \\\"DiscrpAgID\\\": \\\"golden.ca\\\" } To replicate Keys must match normalized username (lowercase, no domain). To modify Add account: add new key-value to defaults . Get username from editor\u0027s login. Change values: edit the Agency, A3, DiscrpAgID strings. 4. Fallback and Resolution Lines 34â€“39 Output: row object Default row for unrecognized users: { \\\"Agency\\\": \\\"CSRD\\\", \\\"A3\\\": \\\"CSRD\\\", \\\"DiscrpAgID\\\": \\\"csrd.bc.ca\\\" } . If HasKey(defaults, uname) , use that row; else use fallback. Logic row = { \\\"Agency\\\": \\\"CSRD\\\", ... } If HasKey(defaults, uname) â†’ row = defaults[uname] To modify Change fallback: edit the default row object. 5. Conditional Field Population Lines 41â€“66 Output: { result: { attributes } } Only fills blanks. For each of Agency, A3, DiscrpAgID: if IsEmpty($feature.Field) , add to updates . If no updates, return. Otherwise return { \\\"result\\\": { \\\"attributes\\\": updates } } . Logic if (IsEmpty($feature.Agency)) updates[\\\"Agency\\\"] = row[\\\"Agency\\\"]; didUpdate = true; (repeat for A3, DiscrpAgID) If !didUpdate â†’ return Return { \\\"result\\\": { \\\"attributes\\\": updates } } To replicate Attribute rules that return multiple fields use the result.attributes object format. To modify Add field: add if (IsEmpty($feature.NewField)) { updates[\\\"NewField\\\"] = row[\\\"NewField\\\"]; didUpdate = true; } and add to row/defaults.","pageId":"rule-defaultagency.html"},{"title":"CSRD NG911 â€” 1. Full Address Rule","path":"docs/rule-full-address.html","content":"Description This rule concatenates up to 16 address component fields into a single formatted address string following the NENA standard sequence. The output format is: Unit-Number Street, Municipality, Province PostalCode . It handles conditional dash separators between numeric prefixes/suffixes and assembles street components in the required NENA order. Metadata Property Value Target Field Full_Addr Triggers Insert, Update Input Fields Unit , AddNum_Pre , Add_Number , AddNum_Suf , St_PreTyp , St_PreSep , St_Name , St_PreMod , St_PreDir , St_PosTyp , St_PosDir , St_PosMod , Post_Code , PostCodeEx , A3 , A1 Returns Formatted address string or Null if empty Full Source Code Arcade Copy // --- Helpers --- function isNumericText (val) { if (val == null || Trim (val) == \\\"\\\" ) return false ; var n = Number (val); return ! IsNan (n); } // --- Unit --- var unitPart = Trim ( DefaultValue ( $feature .Unit, \\\"\\\" )); // --- Address number: prefix + number + suffix (with dash if numeric prefix/suffix) --- var pre = Trim ( DefaultValue ( $feature .AddNum_Pre, \\\"\\\" )); var num = Trim ( DefaultValue ( $feature .Add_Number, \\\"\\\" )); var suf = Trim ( DefaultValue ( $feature .AddNum_Suf, \\\"\\\" )); var prefixSep = \\\"\\\" ; if (pre != \\\"\\\" \u0026amp;\u0026amp; num != \\\"\\\" \u0026amp;\u0026amp; isNumericText (pre)) prefixSep = \\\"-\\\" ; var suffixSep = \\\"\\\" ; if (num != \\\"\\\" \u0026amp;\u0026amp; suf != \\\"\\\" \u0026amp;\u0026amp; isNumericText (suf)) suffixSep = \\\"-\\\" ; var addrNumPart = Trim (pre + prefixSep + num + suffixSep + suf); // --- Unit-Address with dash if both exist --- var unitAddr = \\\"\\\" ; if (unitPart != \\\"\\\" \u0026amp;\u0026amp; addrNumPart != \\\"\\\" ) unitAddr = unitPart + \\\"-\\\" + addrNumPart; else unitAddr = unitPart + addrNumPart; // --- Street type prefix + separator + street name body --- var preTyp = Trim ( DefaultValue ( $feature .St_PreTyp, \\\"\\\" )); var stName = Trim ( DefaultValue ( $feature .St_Name, \\\"\\\" )); var sepRaw = DefaultValue ( $feature .St_PreSep, \\\"\\\" ); var sep = IIF ( Trim (sepRaw) == \\\"\\\" , \\\" \\\" , sepRaw); var preTypName = \\\"\\\" ; if (preTyp != \\\"\\\" \u0026amp;\u0026amp; stName != \\\"\\\" ) { preTypName = Trim (preTyp + sep + stName); } else { preTypName = Trim (preTyp + stName); } // --- Street part in required sequence --- var streetArr = []; var v = \\\"\\\" ; v = Trim ( DefaultValue ( $feature .St_PreMod, \\\"\\\" )); if (v != \\\"\\\" ) Push (streetArr, v); v = Trim ( DefaultValue ( $feature .St_PreDir, \\\"\\\" )); if (v != \\\"\\\" ) Push (streetArr, v); if (preTypName != \\\"\\\" ) Push (streetArr, preTypName); v = Trim ( DefaultValue ( $feature .St_PosTyp, \\\"\\\" )); if (v != \\\"\\\" ) Push (streetArr, v); v = Trim ( DefaultValue ( $feature .St_PosDir, \\\"\\\" )); if (v != \\\"\\\" ) Push (streetArr, v); v = Trim ( DefaultValue ( $feature .St_PosMod, \\\"\\\" )); if (v != \\\"\\\" ) Push (streetArr, v); var streetPart = Concatenate (streetArr, \\\" \\\" ); // --- Base: Unit-AddrNum, Street --- var baseArr = []; if (unitAddr != \\\"\\\" ) Push (baseArr, unitAddr); if (streetPart != \\\"\\\" ) Push (baseArr, streetPart); var base = Concatenate (baseArr, \\\" \\\" ); // --- Postal (Post_Code + optional -PostCodeEx) --- var post = Trim ( DefaultValue ( $feature .Post_Code, \\\"\\\" )); var postEx = Trim ( DefaultValue ( $feature .PostCodeEx, \\\"\\\" )); var postalPart = IIF (post != \\\"\\\" \u0026amp;\u0026amp; postEx != \\\"\\\" , post + \\\"-\\\" + postEx, post); // --- Tail: muni, prov, postal (muni/prov with comma) --- var muni = Trim ( DefaultValue ( $feature .A3, \\\"\\\" )); var prov = Trim ( DefaultValue ( $feature .A1, \\\"\\\" )); var muniProv = \\\"\\\" ; if (muni != \\\"\\\" \u0026amp;\u0026amp; prov != \\\"\\\" ) muniProv = muni + \\\", \\\" + prov; else muniProv = muni + prov; var tailArr = []; if (muniProv != \\\"\\\" ) Push (tailArr, muniProv); if (postalPart != \\\"\\\" ) Push (tailArr, postalPart); var tail = Concatenate (tailArr, \\\" \\\" ); // --- Final: base, tail --- var full = IIF (base != \\\"\\\" \u0026amp;\u0026amp; tail != \\\"\\\" , base + \\\", \\\" + tail, base + tail); return IIF ( Trim (full) == \\\"\\\" , Null , full); Section-by-Section Breakdown 1. Helper: isNumericText Lines 1 \u0026ndash; 6 Input: any value Output: boolean Tests whether a value is a valid number. Returns false for null, empty string, or non-numeric text. Used to decide if address number prefix/suffix should use a dash separator (e.g., \\\"5-1234\\\" vs \\\"A1234\\\"). Logic If val == null or Trim(val) == \\\"\\\" â†’ return false Convert to number: n = Number(val) Return !IsNan(n) To replicate Copy the function verbatim. Arcade uses IsNan (capital N). To modify Change separator logic: edit the prefixSep / suffixSep conditions in section 3 that call this function. 2. Unit Component Lines 8 \u0026ndash; 9 Input: Unit Output: string Extracts the unit/suite identifier. Handles null via DefaultValue($feature.Unit, \\\"\\\") , then trims whitespace. Examples: \\\"101\\\", \\\"A\\\", \\\"Suite 200\\\". To replicate var unitPart = Trim(DefaultValue($feature.Unit, \\\"\\\")); Replace Unit with your unit field name if different. To modify Always prefix with \\\"#\\\": IIF(unitPart != \\\"\\\", \\\"#\\\" + unitPart, \\\"\\\") Different null handling: change the second argument of DefaultValue . 3. Address Number Assembly Lines 11 \u0026ndash; 22 Input: AddNum_Pre, Add_Number, AddNum_Suf Output: string Combines prefix, number, and suffix into a single address number. Dash rule: Use \\\"-\\\" between parts only when the adjacent part is numeric (via isNumericText ). Examples: \\\"5-1234-2\\\" (all numeric), \\\"A1234\\\" (letter prefix), \\\"1234B\\\" (letter suffix). Logic prefixSep = \\\"-\\\" only if preâ‰ \\\"\\\" AND numâ‰ \\\"\\\" AND isNumericText(pre) suffixSep = \\\"-\\\" only if numâ‰ \\\"\\\" AND sufâ‰ \\\"\\\" AND isNumericText(suf) Final: pre + prefixSep + num + suffixSep + suf , trimmed To replicate Requires isNumericText helper (section 1). Field names: AddNum_Pre , Add_Number , AddNum_Suf . To modify Different separator: change \\\"-\\\" to e.g. \\\" \\\" in prefixSep/suffixSep assignments. Always use dash: set prefixSep = \\\"-\\\" when both exist, ignore isNumericText . 4. Unit-Address Join Lines 24 \u0026ndash; 27 Input: unitPart, addrNumPart (derived) Output: string Joins unit and address number. If both exist, uses a dash (e.g., \\\"101-1234\\\"). If only one exists, uses it alone. No trailing/leading separators. Logic If unitPartâ‰ \\\"\\\" AND addrNumPartâ‰ \\\"\\\" â†’ unitPart + \\\"-\\\" + addrNumPart Else â†’ unitPart + addrNumPart (one may be empty) To modify Different separator: change \\\"-\\\" to e.g. \\\" Unit \\\" or \\\" #\\\" . 5. Street Components Lines 29 \u0026ndash; 53 Input: St_PreTyp, St_PreSep, St_Name, St_PreMod, St_PreDir, St_PosTyp, St_PosDir, St_PosMod Output: string Assembles the street name in NENA order : PreMod â†’ PreDir â†’ (PreTyp + Sep + Name) â†’ PosTyp â†’ PosDir â†’ PosMod. St_PreSep controls the separator between type prefix and name (default space). Only non-empty values are pushed to streetArr . Order in streetArr 1. St_PreMod, 2. St_PreDir, 3. preTypName (St_PreTyp + St_PreSep + St_Name), 4. St_PosTyp, 5. St_PosDir, 6. St_PosMod preTypName logic sep = IIF(Trim(St_PreSep)==\\\"\\\", \\\" \\\", St_PreSep) If preTypâ‰ \\\"\\\" AND stNameâ‰ \\\"\\\" â†’ Trim(preTyp + sep + stName) ; else Trim(preTyp + stName) To replicate Build streetArr with Push(streetArr, v) for each component; Concatenate(streetArr, \\\" \\\") for final string. To modify Add a new street field: insert a new v = Trim(DefaultValue($feature.NewField, \\\"\\\")); if (v != \\\"\\\") Push(streetArr, v); in the correct NENA position. Change separator between components: edit the Concatenate(streetArr, \\\" \\\") second argument. 6. Base Address Lines 55 \u0026ndash; 60 Input: unitAddr, streetPart (derived) Output: string Combines the unit-address portion and street portion with a space. Format: UnitAddr StreetPart or either alone if the other is empty. Logic Push unitAddr and streetPart to baseArr if non-empty; Concatenate(baseArr, \\\" \\\") To modify Different separator: change \\\" \\\" in Concatenate. 7. Postal and Tail Assembly Lines 62 \u0026ndash; 83 Input: Post_Code, PostCodeEx, A3, A1 Output: string or Null Builds the tail: municipality + province (comma if both), then postal code. Postal format: Post_Code or Post_Code-PostCodeEx if both exist. Final address: base + \\\", \\\" + tail when both exist; else base + tail . Returns Null if entire result is empty. Logic postalPart: IIF(post!=\\\"\\\" \u0026\u0026 postEx!=\\\"\\\", post+\\\"-\\\"+postEx, post) muniProv: muni + \\\", \\\" + prov if both; else muni + prov tailArr: muniProv, postalPart (space-separated) full: base + \\\", \\\" + tail if both; else base + tail Return IIF(Trim(full)==\\\"\\\", Null, full) To replicate Standard format: Unit-Number Street, Municipality, Province PostalCode To modify Add country: var country = Trim(DefaultValue($feature.Country, \\\"\\\")); and push to tailArr in desired position. Different postal format: edit the postalPart IIF expression.","pageId":"rule-full-address.html"},{"title":"CSRD NG911 â€” 4. Latitude Rule","path":"docs/rule-latitude.html","content":"Description Extracts the Y coordinate (latitude) from feature geometry. Uses identical logic to the Longitude rule, including Web Mercator conversion, but returns the latitude component ( ll[0] ) instead of longitude ( ll[1] ). The current source file contains the same code as Longitude \u0026mdash; during deployment, the return values should reference ll[0] for latitude and g.y for the direct-degree path. Metadata Property Value Target Field Lat Triggers Insert, Update Input Feature Geometry (Y coordinate) Precision 6 decimal places Relationship Mirror of Longitude rule (returns Y instead of X) Full Source Code Deployment Note: The deployed rule should return Round(ll[0], 6) for the Web Mercator path and Round(g.y, 6) for the direct-degree path. The source below currently mirrors the Longitude file \u0026mdash; verify return indices before publishing. Arcade Copy var g = Geometry ( $feature ); if ( IsEmpty (g)) return Null ; if ( TypeOf (g) != \\\"Point\\\" ) g = Centroid (g); var sr = g.spatialReference; var wkid = DefaultValue (sr.wkid, DefaultValue (sr.latestWkid, -1 )); function WebMercatorToLatLon (x, y) { var originShift = 2.0 * PI * 6378137.0 / 2.0 ; var lon = (x / originShift) * 180.0 ; var lat = (y / originShift) * 180.0 ; lat = 180.0 / PI * ( 2.0 * Atan ( Exp (lat * PI / 180.0 )) - PI / 2.0 ); return [lat, lon]; } var x = g.x; var y = g.y; // Web Mercator stored coords â†’ convert if (wkid == 3857 || wkid == 102100 || wkid == 102113 ) { var ll = WebMercatorToLatLon (x, y); return Round (ll[ 1 ], 6 ); // âš Should be ll[0] for latitude } // Already looks like degrees â†’ use directly if ( Abs (x) \u0026lt;= 180 \u0026amp;\u0026amp; Abs (y) \u0026lt;= 90 ) { return Round (x, 6 ); // âš Should be Round(g.y, 6) for latitude } // Other projected CRS (UTM/state plane/etc) â†’ cannot reliably convert here return Null ; Section-by-Section Breakdown This rule mirrors the Longitude rule. Any changes to the Web Mercator conversion function should be applied to both rules simultaneously. 1. Geometry Extraction Lines 1 \u0026ndash; 4 Input: Geometry Output: Point or Null Identical to Longitude rule. Gets geometry; returns Null if empty; uses Centroid(g) for non-points. Keep in sync Any change to Longitude rule section 1 must be applied here. 2. Spatial Reference Detection Lines 6 \u0026ndash; 7 Input: g.spatialReference Identical to Longitude rule. Reads wkid with latestWkid fallback. Keep in sync Match Longitude rule section 2. 3. Web Mercator Conversion Lines 9 \u0026ndash; 24 Input: g.x, g.y (meters) Output: latitude (degrees) Same WebMercatorToLatLon as Longitude. Critical: returns ll[0] (latitude), not ll[1] (longitude). The function returns [lat, lon] . Logic If wkid in {3857, 102100, 102113}: return Round(ll[0], 6) (latitude) To replicate Copy from Longitude rule but change ll[1] to ll[0] . Any CRS/conversion change must be applied to both rules. 4. Direct Degree Handling and Fallback Lines 26 \u0026ndash; 32 Input: x, y Output: number or Null For degree-like coords ( |x| â‰¤ 180 , |y| â‰¤ 90 ), returns Round(y, 6) â€”latitude is the Y component in decimal degrees. For other CRS, returns Null. Logic If degree-like: return Round(y, 6) (not xâ€”Longitude returns x) Else: return Null To modify Add UTM/other CRS: add conversion branch; apply same change to Longitude rule.","pageId":"rule-latitude.html"},{"title":"CSRD NG911 â€” 3. Longitude Rule","path":"docs/rule-longitude.html","content":"Description Automatically extracts the X coordinate (longitude) from each feature\u0027s geometry. If the data is stored in Web Mercator (WKID 3857, 102100, or 102113), it converts to decimal degrees using the inverse Mercator projection formula. Returns the value rounded to 6 decimal places for NENA compliance. Metadata Property Value Target Field Long Triggers Insert, Update Input Feature Geometry (X coordinate) Precision 6 decimal places Supported CRS WGS84 (4326), Web Mercator (3857 / 102100 / 102113) Returns Decimal degrees longitude or Null Full Source Code Arcade Copy var g = Geometry ( $feature ); if ( IsEmpty (g)) return Null ; if ( TypeOf (g) != \\\"Point\\\" ) g = Centroid (g); var sr = g.spatialReference; var wkid = DefaultValue (sr.wkid, DefaultValue (sr.latestWkid, -1 )); function WebMercatorToLatLon (x, y) { var originShift = 2.0 * PI * 6378137.0 / 2.0 ; var lon = (x / originShift) * 180.0 ; var lat = (y / originShift) * 180.0 ; lat = 180.0 / PI * ( 2.0 * Atan ( Exp (lat * PI / 180.0 )) - PI / 2.0 ); return [lat, lon]; } var x = g.x; var y = g.y; // Web Mercator stored coords â†’ convert if (wkid == 3857 || wkid == 102100 || wkid == 102113 ) { var ll = WebMercatorToLatLon (x, y); return Round (ll[ 1 ], 6 ); // lon } // Already looks like degrees â†’ use directly if ( Abs (x) \u0026lt;= 180 \u0026amp;\u0026amp; Abs (y) \u0026lt;= 90 ) { return Round (x, 6 ); // lon } // Other projected CRS (UTM/state plane/etc) â†’ cannot reliably convert here return Null ; Section-by-Section Breakdown 1. Geometry Extraction Lines 1 \u0026ndash; 4 Input: Geometry Output: Point or Null Gets the feature geometry. Returns Null if empty. For polygons/lines, uses Centroid(g) to get a representative point. Points use their coordinates directly. Logic g = Geometry($feature) If IsEmpty(g) â†’ return Null If TypeOf(g) != \\\"Point\\\" â†’ g = Centroid(g) To replicate Use Geometry($feature) and Centroid() for non-points. 2. Spatial Reference Detection Lines 6 \u0026ndash; 7 Input: g.spatialReference Output: wkid number Reads the coordinate system WKID. Uses sr.wkid first; falls back to sr.latestWkid ; defaults to -1 if neither exists. Logic wkid = DefaultValue(sr.wkid, DefaultValue(sr.latestWkid, -1)) To replicate Standard Arcade pattern for CRS detection. 3. Web Mercator Conversion Lines 9 \u0026ndash; 24 Input: g.x, g.y (meters) Output: longitude (degrees) Converts Web Mercator (EPSG:3857, 102100, 102113) X/Y meters to WGS84 decimal degrees. Uses inverse Mercator: lon = (x / originShift) * 180 ; latitude uses Atan(Exp(...)) . Returns ll[1] (longitude) rounded to 6 decimals. Constants originShift = 2 * PI * 6378137.0 / 2 (WGS84 semi-major axis) Logic If wkid in {3857, 102100, 102113}: call WebMercatorToLatLon(x, y) , return Round(ll[1], 6) To replicate Copy WebMercatorToLatLon function. For longitude use ll[1] ; for latitude use ll[0] . 4. Direct Degree Handling and Fallback Lines 26 \u0026ndash; 32 Input: x, y Output: number or Null If coordinates look like degrees ( |x| â‰¤ 180 , |y| â‰¤ 90 ), returns Round(x, 6) directly (no conversion). For other CRS (UTM, State Plane), returns Null â€”conversion would require full projection parameters. Logic If Abs(x) â‰¤ 180 AND Abs(y) â‰¤ 90 â†’ return Round(x, 6) Else â†’ return Null To modify Add UTM/other CRS: add else if (wkid == 26911) branch with appropriate conversion math before the Null return.","pageId":"rule-longitude.html"},{"title":"A. Mandatory Fields â€” CSRD NG911 Attribute Rule","path":"docs/rule-mandatory.html","content":"Description A constraint rule that prevents saving a feature if any of the 8 mandatory fields are blank. Unlike calculation rules which auto-populate fields, this rule validates that critical fields have values and blocks the save with a descriptive error message listing which fields are missing. Deletes are always allowed. Metadata Property Value Rule Type Constraint (blocks save on violation) Triggers Insert, Update Validated Fields Full_Addr , Agency , DiscrpAgID , NGUID , Country , A1 , A2 , A3 On Pass Returns true (save proceeds) On Fail Returns errorMessage listing missing fields Deletes Always allowed Full Source Code Arcade Copy // Allow deletes if ( $editcontext .editType == \\\"DELETE\\\" ) return true ; function isBlank (v) { if ( IsEmpty (v)) return true ; return Trim ( Text (v)) == \\\"\\\" ; } var missing = []; if ( isBlank ( $feature .Full_Addr)) Push (missing, \\\"Full_Addr\\\" ); if ( isBlank ( $feature .Agency)) Push (missing, \\\"Agency\\\" ); if ( isBlank ( $feature .DiscrpAgID)) Push (missing, \\\"DiscrpAgID\\\" ); if ( isBlank ( $feature .NGUID)) Push (missing, \\\"NGUID\\\" ); if ( isBlank ( $feature .Country)) Push (missing, \\\"Country\\\" ); if ( isBlank ( $feature .A1)) Push (missing, \\\"A1\\\" ); if ( isBlank ( $feature .A2)) Push (missing, \\\"A2\\\" ); if ( isBlank ( $feature .A3)) Push (missing, \\\"A3\\\" ); if ( Count (missing) \u0026gt; 0 ) { return { \\\"errorMessage\\\" : \\\"Missing mandatory field(s): \\\" + Concatenate (missing, \\\", \\\" ) }; } return true ; Section Breakdown 1. Delete Bypass Lines 1â€“2 Input: $editcontext.editType Output: true Constraint rules must return true to allow the operation. For deletes, always allowâ€”do not validate field completeness. Returns immediately. Logic if ($editcontext.editType == \\\"DELETE\\\") return true; To replicate Standard pattern for constraint rules. Remove only if deletes should be validated (rare). 2. isBlank Helper Lines 4â€“7 Input: any value Output: boolean Tests if a value is empty or blank. Uses IsEmpty(v) for null/undefined, then Trim(Text(v)) == \\\"\\\" for blank strings. Text() handles numbers, dates, etc. Logic If IsEmpty(v) â†’ true Else Trim(Text(v)) == \\\"\\\" To replicate Copy verbatim. Used for all 8 field checks. 3. Mandatory Field Checks Lines 9â€“18 8 fields: Full_Addr, Agency, DiscrpAgID, NGUID, Country, A1, A2, A3 For each field, if isBlank($feature.Field) , push the field name string to missing . Order determines error message order. Logic if (isBlank($feature.Full_Addr)) Push(missing, \\\"Full_Addr\\\"); (Ã—8) To replicate Add field: if (isBlank($feature.NewField)) Push(missing, \\\"NewField\\\"); Remove field: delete its line. Dependencies Full_Addr, NGUID are auto-calculated by rules 1â€“2; constraint typically blocks when Agency, DiscrpAgID, Country, A1, A2, A3 are blank. 4. Error or Pass Lines 20â€“26 Output: true or { errorMessage } If Count(missing) \u003e 0 , return { \\\"errorMessage\\\": \\\"Missing mandatory field(s): \\\" + Concatenate(missing, \\\", \\\") } . ArcGIS blocks the save and displays the message. Otherwise return true . Logic If missing.length \u003e 0 â†’ return { \\\"errorMessage\\\": \\\"Missing mandatory field(s): \\\" + Concatenate(missing, \\\", \\\") } Else â†’ return true To replicate Constraint rules return true to allow, or { \\\"errorMessage\\\": \\\"...\\\" } to block. To modify Custom message: change the string, e.g. \\\"Please fill: \\\" + Concatenate(missing, \\\", \\\") . Note: This constraint rule works in tandem with the calculation rules. Because Full_Addr , NGUID , and other fields are auto-calculated by rules 1â€“7, this constraint will typically only block saves when Agency , DiscrpAgID , Country , A1 , A2 , or A3 are left blank by the editor.","pageId":"rule-mandatory.html"},{"title":"CSRD NG911 â€” 2. NGUID Rule","path":"docs/rule-nguid.html","content":"Description Generates the National Geographic Unique Identifier (NGUID) in URN format as specified by NENA standards. The NGUID uniquely identifies each address point using the feature\u0027s GlobalID combined with the agency identifier (DiscrpAgID). Format: urn:emergency:uid:gis:SSAP:{GlobalID}:{DiscrpAgID} Metadata Property Value Target Field NGUID Triggers Insert, Update Input Fields GlobalID , DiscrpAgID Output Format urn:emergency:uid:gis:SSAP:{GlobalID}:{DiscrpAgID} Returns URN string or Null if DiscrpAgID is empty Full Source Code Arcade Copy var ag = Trim ( DefaultValue ( $feature .DiscrpAgID, \\\"\\\" )); if (ag == \\\"\\\" ) return Null ; // GlobalID sometimes comes with { } â€” strip them var gid = Text ( $feature .GlobalID); gid = Replace ( Replace (gid, \\\"{\\\" , \\\"\\\" ), \\\"}\\\" , \\\"\\\" ); return \\\"urn:emergency:uid:gis:SSAP:\\\" + gid + \\\":\\\" + ag; Section-by-Section Breakdown 1. Agency Validation Lines 1 \u0026ndash; 2 Input: DiscrpAgID Output: Null (early exit) Ensures the agency identifier exists before building the NGUID. Returns Null immediately if DiscrpAgID is empty or null, preventing invalid URNs. Logic ag = Trim(DefaultValue($feature.DiscrpAgID, \\\"\\\")) If ag == \\\"\\\" â†’ return Null To replicate Replace DiscrpAgID with your agency field name. Must run before GlobalID/URN logic. 2. GlobalID Normalization Lines 4 \u0026ndash; 6 Input: GlobalID (system) Output: string Converts GlobalID to text and strips curly braces { and } . ArcGIS may store GUIDs as {xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx} ; this produces xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx . Logic gid = Text($feature.GlobalID) gid = Replace(Replace(gid, \\\"{\\\", \\\"\\\"), \\\"}\\\", \\\"\\\") To replicate GlobalID is a system field; do not rename. Brace stripping handles both formats. 3. URN Assembly Line 8 Output: NGUID string Builds the NENA-standard NGUID URN. Format: urn:emergency:uid:gis:SSAP:{GlobalID}:{DiscrpAgID} . URN structure Prefix: urn:emergency:uid:gis:SSAP: (fixed) GlobalID: cleaned, no braces Agency: from DiscrpAgID To replicate return \\\"urn:emergency:uid:gis:SSAP:\\\" + gid + \\\":\\\" + ag; To modify Different prefix: change the string literal. Add components: append before the final ag (e.g., + \\\":\\\" + region ).","pageId":"rule-nguid.html"},{"title":"7. QAStatus â€” CSRD NG911 Attribute Rule","path":"docs/rule-qastatus.html","content":"Description The most complex attribute rule in the system. It manages the QA lifecycle of each address feature using three distinct behaviors: (1) preserving explicit QAStatus edits made by GP tools or users, (2) defaulting new features to \\\"Pending\\\" , and (3) automatically resetting to \\\"Pending\\\" when any watched business field changes. This rule is critical for the automated QA pipeline â€” it determines which features the nightly QA tool will validate. Metadata Property Value Target Field QAStatus Triggers Insert, Update Input Fields QAStatus , DiscrpAgID , NGUID , Country , A1 , A2 , A3 , Full_Addr Watched Fields DiscrpAgID , NGUID , Country , A1 , A2 , A3 , Full_Addr Possible Outputs Incoming value (preserved), \\\"Pending\\\" (default/reset), current value (no change) Full Source Code Arcade Copy // Preserve explicit QAStatus edits (including GP tool writes) if ( $originalFeature != null \u0026amp;\u0026amp; $feature .QAStatus != $originalFeature .QAStatus) { return $feature .QAStatus; } // On insert, keep incoming QAStatus if provided (e.g., from QA-\u0026gt;DEFAULT post); // otherwise default to Pending. if ( $originalFeature == null ) { var incomingStatus = Trim ( DefaultValue ( $feature .QAStatus, \\\"\\\" )); return IIF (incomingStatus == \\\"\\\" , \\\"Pending\\\" , $feature .QAStatus); } function sameValue (a, b) { if (a == null \u0026amp;\u0026amp; b == null ) return true ; if (a == null || b == null ) return false ; return Text (a) == Text (b); } // Watch only QA-relevant business fields (exclude DateUpdate to avoid rule loops) var changed = ! sameValue ( $feature .DiscrpAgID, $originalFeature .DiscrpAgID) || ! sameValue ( $feature .NGUID, $originalFeature .NGUID) || ! sameValue ( $feature .Country, $originalFeature .Country) || ! sameValue ( $feature .A1, $originalFeature .A1) || ! sameValue ( $feature .A2, $originalFeature .A2) || ! sameValue ( $feature .A3, $originalFeature .A3) || ! sameValue ( $feature .Full_Addr, $originalFeature .Full_Addr); // If watched fields changed and status wasn\u0027t already Pending, reset to Pending var oldStatus = Lower ( Trim ( DefaultValue ( $originalFeature .QAStatus, \\\"\\\" ))); var isPending = Find ( \\\"pending\\\" , oldStatus) == 0 ; if (changed \u0026amp;\u0026amp; !isPending) { return \\\"Pending\\\" ; } // Otherwise keep current status return $feature .QAStatus; Section Breakdown 1. Preserve Explicit Edits Lines 1â€“4 Input: $originalFeature, QAStatus Output: QAStatus (passthrough) Highest-priority check. If this is an update ( $originalFeature != null ) AND the user/GP tool explicitly changed QAStatus , return the new value immediately. This allows the nightly QA GP tool to write \\\"Passed\\\" , \\\"Warning: ...\\\" , or error messages without the rule overriding them. Logic If $originalFeature != null \u0026\u0026 $feature.QAStatus != $originalFeature.QAStatus â†’ return $feature.QAStatus To replicate Never remove this blockâ€”it enables QA automation. New status values flow through automatically. 2. Insert Default Lines 6â€“11 Input: $originalFeature, QAStatus Output: \\\"Pending\\\" or incoming Handles inserts only ( $originalFeature == null ). If QAStatus is provided (e.g., from reconcile/post), it\u0027s preserved. Otherwise defaults to \\\"Pending\\\" so the feature enters the QA queue. Logic incomingStatus = Trim(DefaultValue($feature.QAStatus, \\\"\\\")) Return IIF(incomingStatus == \\\"\\\", \\\"Pending\\\", $feature.QAStatus) To modify Different default: change \\\"Pending\\\" to e.g. \\\"New\\\" . 3. sameValue Helper Lines 13â€“17 Input: a, b (any) Output: boolean Null-safe comparison. Converts both to text via Text() before comparing. Two nulls â†’ true. One null â†’ false. Required because Arcade\u0027s == doesn\u0027t handle null reliably across field types. Logic If both null â†’ true; if one null â†’ false; else Text(a) == Text(b) To replicate Copy verbatim. Used by section 4 for watched field comparison. 4. Watched Field Change Detection Lines 19â€“38 7 watched: DiscrpAgID, NGUID, Country, A1, A2, A3, Full_Addr Compares current vs original for 7 fields. If any changed AND status wasn\u0027t already \\\"Pending\\\" , reset to \\\"Pending\\\" . DateUpdate is excluded to avoid infinite loops. Logic changed = !sameValue($feature.DiscrpAgID, $originalFeature.DiscrpAgID) || ... (7 fields) isPending = Find(\\\"pending\\\", Lower(Trim($originalFeature.QAStatus))) == 0 If changed \u0026\u0026 !isPending â†’ return \\\"Pending\\\" Else â†’ return $feature.QAStatus To replicate Add field: !sameValue($feature.NewField, $originalFeature.NewField) || Remove field: delete its line. To modify Never add DateUpdate or auto-calculated fieldsâ€”causes loops. Warning: This rule deliberately excludes DateUpdate from the watched fields to prevent infinite loops with rule #6. Adding auto-calculated fields to the watch list will cause every save to reset QAStatus.","pageId":"rule-qastatus.html"},{"title":"Schema Guide","path":"docs/schema-guide.html","content":"Scope This guide covers the SDE.NG911_SiteAddress feature class \u0026mdash; the single authoritative source of civic-address point data for the CSRD NG911 system. Each record represents one site-address point stored as a point feature in NAD 1983 UTM Zone 11N (WKID 26911). The schema follows the NENA i3 Standard for NG9-1-1 GIS Data Model . Directionals (e.g., Southwest, North) and street types (e.g., Road, Highway) must always be written in full \u0026mdash; no abbreviations . Quick Start for Editors Minimum fields to fill on every new address: Agency DiscrpAgID Add_Number St_Name A3 (locality / community) Unit \u0026mdash; if applicable Auto-filled on save (attribute rules): Full_Addr , NGUID , AddCode , DateUpdate , Longitude , Latitude , QAStatus . Do not manually populate these \u0026mdash; they are computed server-side. Multi-Agency Conventions Agency Ownership Each address record belongs to the agency responsible for that jurisdiction. The Agency field stores the display label (used for definition queries in ArcGIS Pro), while DiscrpAgID stores the NENA-compliant domain identifier that feeds into the NGUID. DiscrpAgID Mapping Agency DiscrpAgID CSRD csrd.bc.ca Revelstoke revelstoke.ca Salmon Arm salmonarm.ca Golden golden.ca Sicamous sicamous.ca Adams Lake adamslakeband.org Skw\u0027lax lslb.ca Neskonlith neskonlith.net RDNO rdno.ca Splatsin splatsin.ca Field Reference All 61 fields grouped by function. Click a group header to expand or collapse. Quick Entry 6 fields Field Name Type Purpose Example Notes Agency Text(255) Owning agency label Salmon Arm Use for definition queries DiscrpAgID Text(100) Domain-based agency ID; in NGUID sicamous.ca Not same as Agency Add_Number Integer Primary civic number 431 Numbers only St_Name Text(254) Core street name body Main No type/directional A3 Text(100) Locality / community Sicamous Must match AddCode lookup Unit Text(75) Unit / suite identifier 12 Joins as Unit-Number Civic Number Components 2 fields Field Name Type Purpose Example Notes AddNum_Pre Text(15) Address number prefix A or 12 Rare; numeric inserts dash AddNum_Suf Text(15) Address number suffix A or 1 Numeric inserts dash Street Components 7 fields Field Name Type Purpose Example Notes St_PreMod Text(15) Modifier before name Old, Upper Full words St_PreDir Text(10) Directional before name Southwest No abbreviations St_PreTyp Text(50) Type before name Highway No abbreviations St_PreSep Text(20) Separator PreTyp\u0026#x2194;Name (blank) Blank = space St_PosTyp Text(50) Type after name Road No abbreviations St_PosDir Text(10) Directional after name South No abbreviations St_PosMod Text(25) Modifier after name Extension Full words Jurisdiction \u0026amp; Communities 5 fields Field Name Type Purpose Example Notes Country Text(2) Country code CA Default CA A1 Text(2) Province code BC Default BC A2 Text(100) Regional district Columbia Shuswap Regional District Often constant Uninc_Comm Text(100) Unincorporated community Malakwa Optional Nbrhd_Comm Text(100) Neighborhood community Downtown Optional Postal / MSAG / ESN 5 fields Field Name Type Purpose Example Notes Post_Comm Text(40) Postal community name Sicamous If different from A3 Post_Code Text(7) Postal code V0E 2V0 Standard format PostCodeEx Text(4) Postal extension 123 Optional MSAGComm Text(30) MSAG community (legacy) SICAMOUS Legacy routing ESN Text(5) Emergency Service Number 01234 Legacy routing Legacy Street Fields 4 fields Field Name Type Purpose Example Notes LSt_PreDir Text(2) Legacy pre-directional N Abbreviations OK LSt_Name Text(75) Legacy street name Main St May include type LSt_Typ Text(4) Legacy street type Rd Abbreviations OK LSt_PosDir Text(2) Legacy post-directional SW Abbreviations OK Unit / Interior Location 5 fields Field Name Type Purpose Example Notes Building Text(75) Building name Lakeside Towers Optional Floor Text(75) Floor identifier 3 Optional Room Text(75) Room identifier 201 Optional Seat Text(75) Seat / space Section A Row 3 Seat 14 Optional Addtl_Loc Text(225) Access notes Rear entrance off alley; gate code 1234 Avoid personal info Place / Landmark / Placement 5 fields Field Name Type Purpose Example Notes Place_Type Text(50) Place / site type Residential Optional Placement Text(25) Placement method Entrance Driveway / Rooftop / etc LandmkName Text(150) Landmark name Sicamous Community Hall Optional Milepost Text(150) Milepost reference Hwy 1 MP 23 Optional Elevation Integer Elevation (meters) 520 Not auto-filled Effective Dates 2 fields Field Name Type Purpose Example Notes Effective Date/Time Effective date 2026-03-01 Optional Expire Date/Time Expiration date 2027-10-31 Optional References \u0026amp; Notes 6 fields Field Name Type Purpose Example Notes AddDataURI Text(254) Supporting info URI (internal link) Optional Featureid Text(255) External feature ID SA-ADDR-001234 Optional Parcelid Text(255) Parcel identifier 012-345-678 Optional Roll Text(15) Assessment roll number 12-345-678-901 Optional Addressnotes Text(255) Notes Created from subdivision plan Avoid sensitive info Alternateaccess Text(255) Alternate access Access via back lane Optional Auto-Filled / Attribute Rules 7 fields Field Name Type Purpose Example Notes Full_Addr Text(255) Complete civic address 12-431 Old Southwest Highway 1 Road, Sicamous, BC V0E 2V0 Rule #1 NGUID Text(254) NENA Globally Unique ID urn:emergency:uid:gis:SSAP:3F25\u0026hellip;3301:sicamous.ca Rule #2; needs DiscrpAgID AddCode Text(6) Numeric code from A3 574 Rule #5; from lookup DateUpdate Date/Time Last edit timestamp 2026-02-19 14:22 Rule #6 Longitude Double Longitude (WGS84) -118.944321 Rule #3 Latitude Double Latitude (WGS84) 50.837221 Rule #4 QAStatus Text(255) QA/QC status Pending Rule #7; resets on field change System Fields 7 fields Field Name Type Purpose Example Notes OBJECTID ObjectID System row ID (auto) Not nullable GlobalID GlobalID System GUID (auto) Used in NGUID created_user Text(255) Creator username (auto) Editor tracking created_date Date/Time Creation date (auto) Editor tracking last_edited_user Text(255) Last editor (auto) Editor tracking last_edited_date Date/Time Last edit date (auto) Editor tracking Shape Geometry Point geometry (auto) Edit by placing point Common Examples Single-Family Residence Add_Number 431 St_Name Main St_PosTyp Road A3 Sicamous Full_Addr: 431 Main Road, Sicamous, BC V0E 2V0 Multi-Unit Address Unit 12 Add_Number 431 St_Name Main St_PosTyp Road A3 Sicamous Full_Addr: 12-431 Main Road, Sicamous, BC V0E 2V0","pageId":"schema-guide.html"},{"title":"CSRD NG911 â€” Salmon Arm ETL Sync","path":"docs/script-etl.html","content":"\u0026nbsp; Purpose Syncs a hosted feature service maintained by the City of Salmon Arm into the enterprise CSRD addressing layer. The ETL performs three operations: inserts for new features, updates (both attributes and geometry) for changed features, and deletes for features removed from the source. After sync, it optionally pushes NGUID and CentralGlobalID values back to the source layer. \u0026nbsp; Full Source Code 734 lines 2.NG911-SalmonArmETL.py Show full source (734 lines) Python \u0026mdash; 2.NG911-SalmonArmETL.py Copy \\\"\\\"\\\" Standalone ArcGIS Notebook script: Sync hosted source layer -\u0026gt; enterprise feature service layer. Supports: Inserts, Updates (attributes + geometry), Deletes. \\\"\\\"\\\" from arcgis.gis import GIS from arcgis.features import FeatureLayer from datetime import datetime, timezone import json, os # CONFIG SOURCE_FEATURESERVER_URL = \\\"https://apps.csrd.bc.ca/.../SalmonArmOverwrite/FeatureServer\\\" TARGET_FEATURESERVER_URL = \\\"https://apps.csrd.bc.ca/.../NG911_Address_SalmonArm_Edit/FeatureServer\\\" PRIMARY_KEY_FIELD = \\\"NGUID\\\" ENABLE_GLOBALID_FALLBACK = True ENABLE_FEATUREID_FALLBACK = True ENABLE_REVERSE_ID_SYNC = True BATCH_SIZE = 200 DELETE_MISSING_FROM_TARGET = True DRY_RUN = False # â”€â”€ Key Normalization \u0026amp; Layer Resolution â”€â”€ def normalize_key (val): ... def resolve_layer (url, layer_index): ... def derive_transfer_fields (source, target, schema_fields, key): ... # â”€â”€ Feature Fetching â”€â”€ def fetch_all_features (layer, out_fields, return_geometry= True ): ... def build_index (features, key_field, normalizer): ... # â”€â”€ Diff \u0026amp; Edit â”€â”€ def build_add_feature (src, field_map, src_key, tgt_key): ... def build_update_feature (src, tgt, field_map, oid_field): ... def run_edits (target_layer, adds, updates, delete_oids, dry_run): ... # â”€â”€ Reverse ID Sync â”€â”€ def build_reverse_id_updates (update_pairs, ...): ... def run_source_id_sync_edits (source_layer, updates, dry_run): ... # â”€â”€ Main â”€â”€ def main (): gis = GIS( \\\"home\\\" ) source = resolve_layer(SOURCE_FEATURESERVER_URL, LAYER_INDEX) target = resolve_layer(TARGET_FEATURESERVER_URL, LAYER_INDEX) # Fetch, index, diff, fallback match, edit, reverse sync, notify ... \u0026nbsp; Matching Strategy Features are matched between source and target using a cascading key strategy: Priority Key Method Primary NGUID Case-insensitive string comparison of the full NGUID URN Fallback 1 GlobalID GUID-normalized (braces stripped, lowercased) comparison Fallback 2 Featureid Exact string match on the Featureid field The cascading strategy ensures matching works for both established records (with NGUID) and newly created features that may only have a GlobalID or Featureid. \u0026nbsp; Configuration Show table (6 rows) Parameter Value Description SOURCE_URL Salmon Arm hosted feature service URL ArcGIS Online / Portal feature service endpoint for the source data TARGET_URL Enterprise feature service URL CSRD enterprise feature service endpoint for the target layer BATCH_SIZE 200 Number of features per edit batch (insert/update/delete) DELETE_MISSING True Delete features from target that no longer exist in source REVERSE_ID_SYNC True Push NGUID and CentralGlobalID back to the source layer after matching DRY_RUN False When True, computes diffs but does not apply any edits \u0026nbsp; Key Functions Function Purpose fetch_all_features(layer) Paginated query (2000 features per page) to retrieve all features from a layer build_index(features, key_field) Builds a dictionary index keyed by the specified field for O(1) lookups during matching derive_transfer_fields(source_schema, target_schema) Computes the intersection of fields approved for transfer based on schema compatibility run_edits(layer, adds, updates, deletes) Executes batched edit operations (200 per batch) with error collection per batch build_reverse_id_updates(matched_pairs) Constructs update payloads to sync NGUID and CentralGlobalID back to the source layer \u0026nbsp; Reverse ID Sync After matching and syncing features from source to target, the ETL optionally performs a reverse ID sync . This writes the enterprise-generated NGUID and CentralGlobalID values back to the source Salmon Arm hosted layer, ensuring both systems share consistent identifiers for future sync cycles. Enabled: REVERSE_ID_SYNC = True â€” the default. After each sync run, matched features in the source layer receive the enterprise NGUID and CentralGlobalID. Disabled: Set REVERSE_ID_SYNC = False only when testing or if the source layer is read-only. This prevents write-back operations. \u0026nbsp; Section-by-Section Breakdown 1. Configuration Block Lines 19 \u0026ndash; 47 Constants Key Variables SOURCE_FEATURESERVER_URL \u0026mdash; Hosted feature service (Salmon Arm publishes here). TARGET_FEATURESERVER_URL \u0026mdash; Enterprise feature service (central NG911 SalmonArm edit layer). PRIMARY_KEY_FIELD \u0026mdash; NGUID . Used to match source records to target records. ENABLE_GLOBALID_FALLBACK / ENABLE_FEATUREID_FALLBACK \u0026mdash; When primary key doesn\u0026rsquo;t match, try matching by GlobalID or Featureid. ENABLE_REVERSE_ID_SYNC \u0026mdash; After syncing, writes target GlobalID and NGUID back to source layer. BATCH_SIZE \u0026mdash; Number of features per edit batch (200). DELETE_MISSING_FROM_TARGET \u0026mdash; If True, removes target records not found in source. DRY_RUN \u0026mdash; If True, calculates all operations but does not apply edits. To modify Add a new sync source: duplicate this script and update the source/target URLs. Disable deletes: set DELETE_MISSING_FROM_TARGET = False . Test without writing: set DRY_RUN = True . 2. Layer \u0026amp; Schema Resolution Lines 50 \u0026ndash; 173 10 functions Key Functions resolve_layer(url, index) \u0026mdash; Appends layer index to FeatureServer URL if needed. load_schema_field_names() \u0026mdash; Reads SSAP_Schema.json to get the approved field name list. derive_transfer_fields() \u0026mdash; Intersects source fields, target fields, and schema fields to produce the transfer mapping. Excludes system fields. resolve_actual_field_name() \u0026mdash; Case-insensitive field name resolution against the live layer. Logic Only fields that exist in all three (source layer, target layer, schema JSON) are transferred. 3. Feature Fetching \u0026amp; Indexing Lines 176 \u0026ndash; 286 4 functions Key Functions fetch_all_features() \u0026mdash; Paginates through the entire layer (2000 records/page). build_index(features, key_field) \u0026mdash; Creates a dictionary keyed by normalized primary key. Reports skipped and duplicate counts. geometry_changed(src, tgt) \u0026mdash; JSON-serializes both geometries for deep comparison. 4. Diff \u0026amp; Edit Payloads Lines 288 \u0026ndash; 350 4 functions Functions build_add_feature() \u0026mdash; Constructs an insert payload from source feature. build_update_feature() \u0026mdash; Compares each mapped field; returns None if nothing changed. chunks(items, size) \u0026mdash; Splits edit lists into batches of BATCH_SIZE . run_edits() \u0026mdash; Applies adds, updates, and deletes in batches. 5. Fallback Key Matching Lines 550 \u0026ndash; 603 Core matching logic Logic Primary match by NGUID : source \u0026cap; target = updates; source-only = inserts; target-only = deletes. GlobalID fallback: unmatched records re-indexed by GlobalID. Featureid fallback: same process with Featureid for still-unmatched records. Final insert/delete lists exclude records resolved by fallback. To modify Add a new fallback field: append a definition to the fallback_definitions list. 6. Reverse ID Sync Lines 353 \u0026ndash; 408 2 functions Purpose After syncing source \u0026rarr; target, writes the target\u0026rsquo;s NGUID and GlobalID back to the source layer into CentralGlobalID . Functions build_reverse_id_updates() \u0026mdash; Patches source OID with target NGUID/GlobalID. run_source_id_sync_edits() \u0026mdash; Applies the reverse updates in batches. 7. Main \u0026amp; Notification Lines 486 \u0026ndash; 734 Entry point Flow Signs in \u0026rarr; resolves layers \u0026rarr; resolves fields \u0026rarr; configures fallbacks. Fetches all source and target features \u0026rarr; builds indexes \u0026rarr; computes diff. Runs fallback matching \u0026rarr; builds add/update/delete payloads \u0026rarr; applies edits. Optionally runs reverse ID sync \u0026rarr; saves result JSON \u0026rarr; sends Power Automate notification. Output JSON run summary with: record counts, key match stats, fallback stats, planned vs. applied operations, failure samples, reverse sync status.","pageId":"script-etl.html"},{"title":"CSRD NG911 â€” Export Tool","path":"docs/script-export.html","content":"\u0026nbsp; Purpose Exports the DEFAULT feature class to a File Geodatabase, compresses it into a ZIP archive, and copies the result to the network share for distribution. This creates a nightly snapshot of the authoritative NG911 data that can be consumed by external agencies and backup systems. \u0026nbsp; Full Source Code 181 lines ExportGPtool.py Show full source (181 lines) Python \u0026mdash; ExportGPtool.py Copy import arcpy, os, json, traceback, zipfile, shutil from datetime import datetime FINAL_DROP_DIR = r\\\"\\\\GIS\\Scripts\\Geoshare\\NG911 Exports\\\" DEFAULT_TARGET_FC = r\\\"SDE.CSRD_SSAP_V3_VersionTesting\\\" def write_test (folder, label): ... def zip_folder_skip_locks (folder_path, zip_path): ... def release_gdb_locks (): ... def export_feature_class_from_sde (sde_conn, target_fc, out_fgdb): ... def main (): sde_conn = arcpy.GetParameterAsText( 0 ) target_fc_text = arcpy.GetParameterAsText( 1 ) name_prefix = arcpy.GetParameterAsText( 2 ) scratch = arcpy.env.scratchFolder fgdb_path = os.path.join(scratch, f \\\"{name_prefix}_{ts}.gdb\\\" ) arcpy.management.CreateFileGDB(scratch, fgdb_name) export_feature_class_from_sde(sde_conn, target_fc, fgdb_path) # Release locks, zip, copy to network share release_gdb_locks() zip_folder_skip_locks(fgdb_path, zip_path) shutil.copy2(zip_path, os.path.join(FINAL_DROP_DIR, zip_name)) arcpy.SetParameterAsText( 3 , json.dumps(result)) \u0026nbsp; Workflow Export Pipeline Create FGDB â€” Creates a new File Geodatabase in the scratch workspace folder Export Feature Class â€” Copies the DEFAULT feature class into the FGDB using FeatureClassToFeatureClass Release Locks â€” Explicitly releases any geodatabase locks to allow file operations ZIP the FGDB â€” Compresses the FGDB folder into a ZIP archive, skipping any .lock files Copy to Network Share â€” Copies the ZIP to \\\\GIS\\Scripts\\Geoshare\\NG911 Exports Output File name: {prefix}_{timestamp}.zip Location: \\\\GIS\\Scripts\\Geoshare\\NG911 Exports The timestamp format is YYYYMMDD_HHmmss , giving each export a unique file name tied to the exact run time. The .lock file skip ensures the ZIP is never corrupted by stale geodatabase lock files from the scratch workspace. \u0026nbsp; Parameters # Name Type Description 0 sde_conn File Path to the SDE connection file (.sde) 1 target_fc String Fully qualified feature class name (e.g., SDE.NG911\\SDE.NG911_SiteAddress ) 2 name_prefix String Prefix for the output ZIP file name (e.g., NG911_SSAP ) 3 result_json String Output JSON with export result details (derived parameter) \u0026nbsp; Section-by-Section Breakdown 1. Utility Functions Lines 1 \u0026ndash; 44 5 functions Functions write_test(folder, label) \u0026mdash; Writes a temp file to verify write access, then deletes it. zip_folder_skip_locks(folder_path, zip_path) \u0026mdash; Walks the FGDB folder, writes all files to ZIP except .lock files. release_gdb_locks() \u0026mdash; Clears ArcPy workspace and cache to release file locks. _resolve_target_fc_input(sde_conn, text) \u0026mdash; Accepts dataset path or JSON with {\\\"url\\\":\\\"...\\\"} . Converts full SDE paths to workspace-relative paths. 2. Export Engine Lines 73 \u0026ndash; 92 Function export_feature_class_from_sde(sde_conn, target_fc, out_fgdb) \u0026mdash; Sets workspace, verifies FC exists (lists sample FCs on failure), validates datasetType , runs FeatureClassToFeatureClass . 3. Main Pipeline Lines 94 \u0026ndash; 181 Flow Reads parameters \u0026rarr; resolves target FC \u0026rarr; falls back to DEFAULT_TARGET_FC if blank. Uses arcpy.env.scratchFolder for temp FGDB \u0026rarr; exports \u0026rarr; releases locks \u0026rarr; zips \u0026rarr; copies to FINAL_DROP_DIR . Key constants FINAL_DROP_DIR = \\\\GIS\\Scripts\\Geoshare\\NG911 Exports DEFAULT_TARGET_FC = SDE.CSRD_SSAP_V3_VersionTesting To modify Change output location: update FINAL_DROP_DIR . Export additional feature classes: add more FeatureClassToFeatureClass calls.","pageId":"script-export.html"},{"title":"CSRD NG911 â€” Nightly Orchestrator","path":"docs/script-orchestrator.html","content":"\u0026nbsp; Purpose Master pipeline script running nightly on ArcGIS Notebook Server. Executes 5 stages sequentially â€” reconciling municipal editor versions through a QA gate into the production DEFAULT layer, exporting an FGDB snapshot, and syncing approved data back down. On completion it saves a JSON summary and sends a Power Automate notification email with full run details. \u0026nbsp; Full Source Code 772 lines 1NightlyQAReconcileExportNotebook.py Show full source (772 lines) Python \u0026mdash; 1NightlyQAReconcileExportNotebook.py Copy \\\"\\\"\\\" Nightly orchestration notebook for ArcGIS Notebook (Standard runtime): 1) Reconcile/Post municipal versions into QA (web tool). 2) Run QA checks (schema + NGUID uniqueness) against the QA layer. 3) If QA passes, export QA to FGDB/ZIP via export web tool. \\\"\\\"\\\" from arcgis.gis import GIS from arcgis.geoprocessing import import_toolbox from arcgis.features import FeatureSet from collections import Counter from datetime import datetime import csv, json, os, re, time from typing import Dict, List, Optional, Tuple # CONFIG RECON_GP_URL = \\\"https://apps.csrd.bc.ca/.../ReconcilePostTraditional/GPServer\\\" EXPORT_GP_URL = \\\"https://apps.csrd.bc.ca/.../ExportSSAP/GPServer\\\" SDE_CONN_UNC = r\\\"\\\\GIS\\Scripts\\NG911\\...\\sde@regional.sde\\\" DEFAULT_VERSION = \\\"sde.DEFAULT\\\" QA_VERSION = \\\"SDE.QA\\\" EDITOR_VERSIONS = \\\"SDE.CSRD;SDE.Revelstoke;SDE.Golden;SDE.Salmon Arm;SDE.Sicamous\\\" CONFLICT_POLICY = \\\"ABORT_CONFLICTS\\\" ACQUIRE_LOCKS = \\\"LOCK_ACQUIRED\\\" TARGET_LAYER_URL = \\\"https://apps.csrd.bc.ca/.../NG911_Address_QA/FeatureServer/0\\\" MANDATORY_FIELDS = [ \\\"DiscrpAgID\\\" , \\\"DateUpdate\\\" , \\\"NGUID\\\" , \\\"Country\\\" , \\\"A3\\\" , \\\"A2\\\" , \\\"A1\\\" ] NB_RUN_DIR = \\\"/arcgis/home/run_summaries\\\" # â”€â”€ Reconcile Helpers â”€â”€ def parse_result (payload): ... def unwrap_gp_response (resp): ... def run_reconcile_stage (tbx, stage, gis): ... # â”€â”€ QA Helpers (15+ functions, 450+ lines) â”€â”€ def normalize_type (t): ... def load_expected_fields (schema_path, dataset_name, mode): ... def get_actual_fields (target): ... def compare_fields (expected, actual): ... def check_nguid_uniqueness (target, nguid_field): ... def check_field_nulls (target, fields): ... def check_field_duplicates (target, field_name): ... def run_qa_checks (target_layer, dataset_name): ... def qa_passed (report): ... # â”€â”€ Export \u0026amp; Notification â”€â”€ def run_export (tbx_export, gis): ... def send_power_automate_notification (summary, status): ... def finalize_run (summary, run_id, status): ... # â”€â”€ MAIN â”€â”€ def main (): gis = GIS( \\\"home\\\" ) tbx_recon = import_toolbox(RECON_GP_URL, gis=gis) tbx_export = import_toolbox(EXPORT_GP_URL, gis=gis) run_id = datetime.now().strftime( \\\"%Y%m%d_%H%M%S\\\" ) # Stage 1: MUNI -\u0026gt; QA res = run_reconcile_stage(tbx_recon, \\\"MUNI_TO_QA\\\" , gis) if not res.get( \\\"success\\\" ): return # Stage 2: QA checks qa = run_qa_checks(TARGET_LAYER_URL) if not qa_passed(qa): return # Stage 3: Export FGDB/ZIP res_export = run_export(tbx_export, gis) # Finalize \u0026amp; notify finalize_run(summary, run_id, status) \u0026nbsp; Pipeline Stages # Stage Name Action On Failure 1 MUNI \u0026rarr; QA Reconcile/post all municipal editor versions into SDE.QA Pipeline stops immediately 2 Run QA Execute QA validation GP service; update QAStatus on all scoped features Configurable via QA_BLOCKING 3 QA \u0026rarr; DEFAULT Reconcile/post SDE.QA into sde.DEFAULT Pipeline stops immediately 4 Export FGDB Export DEFAULT feature class to File Geodatabase, zip, copy to network share Pipeline stops immediately 5 DEFAULT \u0026rarr; MUNI Reconcile DEFAULT back to municipal versions (NO_POST) so QAStatus flows down Pipeline stops immediately \u0026nbsp; Key Configuration Parameter Value Description SDE_CONN_UNC \\\\GIS\\Scripts\\NG911\\...\\sde@regional.sde UNC path to the SDE connection file EDITOR_VERSIONS SDE.CSRD; SDE.Revelstoke; SDE.Golden; SDE.Salmon Arm; SDE.Sicamous Semicolon-delimited list of municipal editor versions CONFLICT_POLICY NO_ABORT Auto-resolve conflicts instead of aborting on detection QA_BLOCKING False When False, QA failures produce warnings but don\u0027t halt the pipeline EMAIL_ON_COMPLETE True Send Power Automate notification email on pipeline completion \u0026nbsp; Key Functions Show table (6 rows) Function Purpose run_reconcile_stage(stage, gis) Submits a reconcile/post GP job for the given stage mode and polls until completion run_qa_stage(gis) Submits the QA validation GP job with all 15 parameters configured run_export_stage(gis) Submits the export GP job to create an FGDB ZIP and copy to the network share _poll_job_result(gis, url, job_id) Polls GP job status every 3 seconds with a 30-minute timeout; returns result JSON build_email_payload(summary) Constructs the JSON payload for Power Automate with stage statuses, QA counters, and run metadata finalize_run(summary, id, status) Saves the JSON run summary to disk and dispatches the notification email \u0026nbsp; Error Handling Each stage checks success before proceeding to the next. The pipeline uses a sequential gate pattern: Stage gate: If a stage returns a failure status, the pipeline records the failure in the summary and skips all subsequent stages. QA flexibility: When QA_BLOCKING=False , QA failures are recorded as warnings in the summary but do not prevent stages 3â€“5 from executing. Conflict normalization: Reconcile results are normalized â€” \\\"conflicts detected\\\" with NO_ABORT policy is treated as a successful auto-resolution, not a failure. Timeout protection: _poll_job_result enforces a 30-minute ceiling on any single GP job to prevent indefinite hangs. Even on failure, finalize_run always executes â€” the summary JSON is saved and the notification is sent regardless of pipeline outcome, so administrators are always informed. \u0026nbsp; Section-by-Section Breakdown 1. Configuration Block Lines 23 \u0026ndash; 69 Constants \u0026amp; toggles Purpose Central location for all environment-specific settings. Every variable the script needs is defined here so nothing is hard-coded deeper in the logic. Key Variables RECON_GP_URL / EXPORT_GP_URL \u0026mdash; REST endpoints for the Reconcile/Post and Export GP services. SDE_CONN_UNC \u0026mdash; UNC path to the .sde connection file used by GP tools. DEFAULT_VERSION / QA_VERSION / EDITOR_VERSIONS \u0026mdash; versioning identifiers (semicolon-separated for editors). CONFLICT_POLICY / ACQUIRE_LOCKS \u0026mdash; reconcile behavior ( ABORT_CONFLICTS or NO_ABORT ). TARGET_LAYER_URL \u0026mdash; the QA feature layer REST URL used for schema/NGUID checks. MANDATORY_FIELDS \u0026mdash; list of fields that must be non-null (e.g., DiscrpAgID, NGUID, Country, A3). EMAIL_ON_COMPLETE / POWER_AUTOMATE_FLOW_URL \u0026mdash; toggle and endpoint for email notifications. To modify Add a new municipality: append to EDITOR_VERSIONS (e.g., ;SDE.NewMuni ). Change QA target: update TARGET_LAYER_URL to the new feature service URL. Enable email: set EMAIL_ON_COMPLETE = True and paste the Power Automate trigger URL. 2. Reconcile Helpers Lines 72 \u0026ndash; 113 3 functions Functions parse_result(payload) \u0026mdash; Normalizes GP output (dict, string, or None) into a consistent dictionary. Handles nested result_json strings. unwrap_gp_response(resp) \u0026mdash; Handles both sync (dict) and async (job with .result() ) GP responses. run_reconcile_stage(tbx, stage, gis) \u0026mdash; Calls tbx.reconcile_post_traditional() with the configured parameters and returns parsed result. To modify Change conflict resolution: edit the parameters passed in run_reconcile_stage . Add retry logic: wrap the tbx.reconcile_post_traditional() call in a retry loop. 3. QA Helpers (In-Notebook) Lines 115 \u0026ndash; 618 15+ functions Purpose Self-contained QA validation that runs directly in the notebook. Used to validate the QA layer before deciding whether to export. Key Functions normalize_type(t) \u0026mdash; Maps Esri field type strings to short names. load_expected_fields() \u0026mdash; Reads SSAP_Schema.json to build expected field definitions. get_actual_fields() \u0026mdash; Fetches live field definitions from the target layer. compare_fields() \u0026mdash; Produces missing/extra/detail arrays comparing expected vs. actual schemas. check_nguid_uniqueness() \u0026mdash; Counts nulls/empties/duplicates for NGUID values. check_field_nulls() \u0026mdash; Counts null/empty values for each mandatory field. check_field_duplicates() \u0026mdash; Finds duplicate Full_Addr values with OID references. run_qa_checks() \u0026mdash; Master function: orchestrates all checks. qa_passed(report) \u0026mdash; Boolean gate: True only if no missing fields, no mandatory nulls, no NGUID duplicates. QA Pass/Fail Logic Blocking : Missing schema fields, mandatory nulls, NGUID duplicates, invalid NGUID format. Warning only : Address duplicates, Shape in missing fields. 4. Export \u0026amp; Notification Lines 621 \u0026ndash; 678 3 functions Functions run_export(tbx_export, gis) \u0026mdash; Calls the Export GP tool with SDE_CONN_UNC , target layer as a FeatureSet, and EXPORT_NAME_PREFIX . send_power_automate_notification() \u0026mdash; POSTs the run summary JSON to the Power Automate flow URL. finalize_run() \u0026mdash; Writes the complete run summary to NB_RUN_DIR as JSON, then triggers notification. To modify Change export target: update EXPORT_NAME_PREFIX or TARGET_LAYER_URL . Add Slack/Teams notification: add a second POST call inside finalize_run() . 5. Main Pipeline Lines 681 \u0026ndash; 772 Entry point Flow Init \u0026mdash; Signs in via GIS(\\\"home\\\") , imports both GP toolboxes, creates run ID timestamp. Stage 1 \u0026mdash; Reconcile MUNI \u0026rarr; QA. Stops pipeline if it fails. Stage 2 \u0026mdash; QA checks. Stops if QA fails. Stage 3 \u0026mdash; Export to FGDB ZIP. Finalize \u0026mdash; Writes JSON summary, sends notification. Error handling Each stage short-circuits on failure with status like \\\"reconcile_failed\\\" , \\\"qa_failed\\\" , \\\"export_failed\\\" . Run summaries are always written regardless of outcome.","pageId":"script-orchestrator.html"},{"title":"CSRD NG911 â€” QA Validation Tool","path":"docs/script-qa.html","content":"\u0026nbsp; Purpose Comprehensive SSAP data quality validation published as an ArcGIS GP service. Performs schema comparison, NGUID integrity checks, mandatory field validation, and address duplicate detection. Updates the QAStatus field on each feature with a pass/warning/error result and generates CSV artifacts for review. \u0026nbsp; Full Source Code 973 lines QASSAPGPtool.py Show full source (973 lines) Python \u0026mdash; QASSAPGPtool.py Copy # QASSAPGPtool.py â€” QA automation script tool for SSAP # 15 Script Tool parameters import arcpy, csv, json, os, re, traceback from collections import Counter from datetime import datetime, timedelta NON_BLOCKING_MISSING_FIELDS = { \\\"shape\\\" } NEW_FEATURE_LOOKBACK_HOURS = 24 # Schema Validation def _load_expected_fields (schema_path, dataset_name, mode): ... def _get_actual_fields (target): ... def _compare_fields (expected, actual, check_types, check_lengths): ... # QA Scope def _resolve_check_scope (target, qa_status_field, lookback_hours): ... # NGUID, Nulls, Duplicates def _check_nguid (target, normalize, check_format, scoped_oids): ... def _check_mandatory_nulls (target, fields, scoped_oids): ... def _check_duplicates (target, field_name, scoped_oids): ... # QAStatus Engine def _build_qastatus_updates (target, oid_field, qa_status_field, ...): ... def _apply_qastatus_updates (target, oid_field, qa_status_field, updates): ... def _summarize_issues_by_agency (target, oid_field, updates, agency_field): ... # Pass/Fail Gate def _qa_passed (report): ... # Main def main (): target_layer = arcpy.GetParameterAsText( 0 ) # ... reads all 15 parameters scope = _resolve_check_scope(target_layer, qa_status_field) expected = _load_expected_fields(schema_json, dataset_name, mode) actual = _get_actual_fields(target_layer) # ... runs all checks, updates QAStatus, writes log _set_result_output(json.dumps(result)) \u0026nbsp; QA Checks Check Description Severity Schema Comparison Validates field names, types, and lengths against the reference SSAP_Schema.json Blocking NGUID Uniqueness Ensures no duplicate NGUID values exist across the feature class Blocking NGUID Format Validates NGUID matches urn:emergency:uid:gis:SSAP:{GUID}:{AgencyID} Blocking Mandatory Nulls Checks that all mandatory fields contain non-null, non-empty values Blocking Address Duplicates Detects duplicate Full_Addr values (configurable fields and tolerance) Warning \u0026nbsp; Scope Logic The QA tool does not re-validate the entire feature class on every run. It scopes to features matching either condition: QAStatus != \\\"Passed\\\" â€” any feature that hasn\u0027t already been approved Created or edited within the 24-hour lookback window â€” catches recently touched records even if their QAStatus was manually set This scoping strategy keeps run times short while ensuring no new or modified data slips through without validation. \u0026nbsp; Parameters Show table (15 rows) # Name Type Description 0 target_layer String Feature class path or feature service URL to validate 1 schema_json File Path to the reference schema definition JSON file 2 dataset_name String Dataset name for labeling (optional, defaults to FC name) 3 mode String Validation scope: all , required , or nonnullable 4 check_types Boolean Validate field data types against schema 5 check_lengths Boolean Validate field lengths against schema maximums 6 check_nguid Boolean Run NGUID uniqueness and format checks 7 normalize_nguid Boolean Normalize NGUID casing before comparison 8 mandatory_fields String Semicolon-delimited list of fields to check for nulls 9 address_dup_fields String Fields used for duplicate address detection 10 address_dup_tolerance Double Spatial tolerance for address duplicate grouping 11 qa_status_field String Name of the QAStatus field to write results to 12 qa_status_write Boolean Whether to write QAStatus updates back to the layer 13 out_log_folder Folder Directory for output logs and CSV artifacts 14 result_json String Output JSON string with run summary (derived) \u0026nbsp; QAStatus Update Flow Passed Feature has zero blocking errors and zero warnings. QAStatus is set to \\\"Passed\\\" . Warning Feature has non-blocking issues only (e.g., address duplicates). QAStatus is set to \\\"Warning: {details}\\\" . Error Feature has one or more blocking errors. QAStatus is set to a semicolon-delimited error list: \\\"Error1; Error2\\\" . \u0026nbsp; Output Artifacts File Description qa_run_{ts}.json Complete run summary with check results, feature counts, pass/fail/warning totals, and timing mandatory_null_failures_{ts}.csv CSV listing every feature with mandatory null violations â€” includes OBJECTID, NGUID, and the offending fields address_duplicates_{ts}.csv CSV of detected address duplicate groups with Full_Addr, OBJECTID pairs, and spatial distance \u0026nbsp; Section-by-Section Breakdown 1. Schema Validation Lines 95 \u0026ndash; 177 3 functions Functions _load_expected_fields(schema_path, dataset_name, mode) \u0026mdash; Reads SSAP_Schema.json . Filters fields by mode: all , required , nonnullable . _get_actual_fields(target) \u0026mdash; Uses arcpy.ListFields() to get the live field list. _compare_fields(expected, actual) \u0026mdash; Returns missing, extra, and per-field details. QA Impact Missing schema fields (except Shape ) are blocking . Type/length mismatches are reported but do not block. 2. QA Scope Resolution Lines 226 \u0026ndash; 287 Smart row filtering Logic Scopes to rows where QAStatus != \\\"Passed\\\" OR rows created within 24 hours. Output Returns scoped_oids set. Reports total rows, rows in scope, not passed, newly created. 3. NGUID Uniqueness Check Lines 315 \u0026ndash; 334 Logic Reads all NGUID values for scoped OIDs via SearchCursor . Counts: null, empty, duplicates (using Counter ). Optionally validates GUID format with regex. QA Impact : Any duplicate NGUID is blocking . 4. Mandatory Null Detection Lines 337 \u0026ndash; 394 2 functions Functions _check_mandatory_nulls() \u0026mdash; Counts null/empty per mandatory field. _collect_null_failures() \u0026mdash; Per-feature failure report. Writes mandatory_null_failures_{ts}.csv . QA Impact : Any mandatory field with nulls is blocking . 5. Address Duplicate Detection Lines 397 \u0026ndash; 466 Logic Normalizes Full_Addr to uppercase, builds duplicate map with OIDs and NGUIDs. Writes address_duplicates_{ts}.csv . QA Impact : Warnings only \u0026mdash; do not block QA pass. 6. QAStatus Update Engine Lines 521 \u0026ndash; 636 3 functions Functions _build_qastatus_updates() \u0026mdash; Per-row: \\\"Passed\\\" | \\\"Warning: ...\\\" | \\\"error1; error2\\\" _apply_qastatus_updates() \u0026mdash; UpdateCursor with edit session fallback for versioned data. _summarize_issues_by_agency() \u0026mdash; Aggregates pass/fail/warning per agency. 7. Main Execution \u0026amp; Output Lines 742 \u0026ndash; 973 Flow Reads all 15 parameters \u0026rarr; resolves QA scope \u0026rarr; runs all checks. Builds QAStatus updates \u0026rarr; summarizes by agency \u0026rarr; optionally applies. Writes JSON log \u0026rarr; sets result_json output parameter.","pageId":"script-qa.html"},{"title":"CSRD NG911 â€” Reconcile/Post Tool","path":"docs/script-reconcile.html","content":"\u0026nbsp; Purpose ArcPy wrapper for traditional versioning reconcile/post operations, published as an ArcGIS GP service. Supports three distinct stage modes that control data flow direction, posting behavior, and conflict resolution strategy within the CSRD versioning hierarchy. \u0026nbsp; Full Source Code 270 lines ReconcilePostGPtool.py Show full source (270 lines) Python \u0026mdash; ReconcilePostGPtool.py Copy # ReconcilePostTraditional.py # Stages: MUNI_TO_QA | QA_TO_DEFAULT | DEFAULT_TO_MUNI_SYNC import arcpy, os, json, traceback from datetime import datetime def _reconcile_versions (workspace, target_version, edit_versions, acquire_locks, abort_if_conflicts, out_log, conflict_definition= \\\"BY_ATTRIBUTE\\\" , conflict_resolution= \\\"FAVOR_EDIT_VERSION\\\" , with_post= \\\"POST\\\" , with_delete= \\\"KEEP_VERSION\\\" ): arcpy.management.ReconcileVersions( workspace, \\\"ALL_VERSIONS\\\" , target_version, edit_versions, acquire_locks, abort_if_conflicts, conflict_definition, conflict_resolution, with_post, with_delete, out_log) return arcpy.GetMessages() def main (): sde_conn = arcpy.GetParameterAsText( 0 ) stage = arcpy.GetParameterAsText( 1 ) # ... reads 9 parameters, validates, runs stage branch if stage == \\\"MUNI_TO_QA\\\" : msgs = _reconcile_versions(sde_conn, qa_version, editor_versions, acquire_locks, conflict_policy, log_path, conflict_resolution= \\\"FAVOR_EDIT_VERSION\\\" , with_post= \\\"POST\\\" ) elif stage == \\\"QA_TO_DEFAULT\\\" : msgs = _reconcile_versions(sde_conn, default_version, qa_version, conflict_resolution= \\\"FAVOR_EDIT_VERSION\\\" , with_post= \\\"POST\\\" ) elif stage == \\\"DEFAULT_TO_MUNI_SYNC\\\" : msgs = _reconcile_versions(sde_conn, default_version, editor_versions, conflict_resolution= \\\"FAVOR_TARGET_VERSION\\\" , with_post= \\\"NO_POST\\\" ) arcpy.SetParameterAsText( 8 , json.dumps(result)) \u0026nbsp; Stage Modes Stage Direction Post Conflict Resolution MUNI_TO_QA Municipal editors \u0026rarr; SDE.QA POST FAVOR_EDIT_VERSION QA_TO_DEFAULT SDE.QA \u0026rarr; sde.DEFAULT POST FAVOR_EDIT_VERSION DEFAULT_TO_MUNI_SYNC sde.DEFAULT \u0026rarr; Municipal editors NO_POST FAVOR_TARGET_VERSION DEFAULT_TO_MUNI_SYNC uses NO_POST combined with FAVOR_TARGET_VERSION so that QAStatus values and other approved data from DEFAULT flow down to municipal versions without overwriting any pending local edits. \u0026nbsp; Parameters Show table (9 rows) # Name Type Description 0 sde_conn File Path to the SDE connection file (.sde) 1 stage String Operation mode: MUNI_TO_QA , QA_TO_DEFAULT , or DEFAULT_TO_MUNI_SYNC 2 qa_version String Name of the QA version (e.g., SDE.QA ) 3 default_version String Name of the default version (e.g., sde.DEFAULT ) 4 editor_versions String Semicolon-delimited list of municipal editor version names 5 out_log_folder Folder Directory for reconcile log files 6 conflict_policy String Conflict handling: NO_ABORT or ABORT_CONFLICTS 7 lock_policy String Lock acquisition: LOCK_ACQUIRED or NO_LOCK_ACQUIRED 8 result_json String Output JSON with reconcile results (derived parameter) \u0026nbsp; Error Handling Input validation: Checks that the SDE connection file exists and the stage mode is a recognized value before proceeding Log stubs: Creates an initial log entry before the reconcile call so the file exists even if ArcPy crashes mid-operation Traceback capture: Wraps the arcpy.ReconcileVersions_management call in a try/except and captures full tracebacks into the result JSON Per-version results: When processing multiple editor versions, each version\u0027s reconcile is run individually and results are collected â€” a failure on one version doesn\u0027t prevent attempts on the remaining versions \u0026nbsp; Section-by-Section Breakdown 1. Helpers \u0026amp; Validation Lines 28 \u0026ndash; 91 6 functions Functions _normalize_list(s) \u0026mdash; Strips whitespace and empty entries from semicolon-separated version lists. _validate_choice(val, allowed, name) \u0026mdash; Validates stage, conflict_policy, and acquire_locks. _reconcile_versions() \u0026mdash; Wrapper around arcpy.management.ReconcileVersions with configurable conflict definition, resolution, and post behavior. 2. Stage Execution Logic Lines 96 \u0026ndash; 233 3 stage branches Stages MUNI_TO_QA \u0026mdash; Reconciles all editor versions into QA. Uses FAVOR_EDIT_VERSION + POST . QA_TO_DEFAULT \u0026mdash; Reconciles QA into DEFAULT. Same settings. DEFAULT_TO_MUNI_SYNC \u0026mdash; Reconciles DEFAULT into municipal versions with NO_POST + FAVOR_TARGET_VERSION . Pushes QAStatus back to editors. To modify Change conflict resolution: edit conflict_resolution in the specific stage branch. Add a new stage: add an elif branch and update _validate_choice allowed set. 3. Error Handling \u0026amp; Output Lines 235 \u0026ndash; 270 Logic On success: writes result_json with success: true , log path, GP messages. On failure: writes FAILED_{ts}.txt traceback, sets result_json with error, re-raises.","pageId":"script-reconcile.html"}];
